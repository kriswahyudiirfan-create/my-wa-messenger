<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Pro v14.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root { --green: #075e54; --light-green: #25d366; --white: #ffffff; --bg: #e5ddd5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Splash Screen 2 Detik */
        #splash { position: fixed; inset: 0; background: var(--green); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; transition: opacity 0.5s; }
        
        /* Notif Header */
        #notif-pop { position: fixed; top: -100px; left: 5%; width: 90%; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2500; transition: 0.5s; display: flex; align-items: center; gap: 10px; border-left: 5px solid var(--light-green); }
        #notif-pop.show { top: 15px; }

        header { background: var(--green); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        /* Contact List Area */
        #main-ui { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #contact-list { flex: 1; overflow-y: auto; background: white; }
        .contact-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; position: relative; }
        .avatar { width: 48px; height: 48px; background: #075e54; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; position: relative; }
        
        .badge { position: absolute; right: 20px; background: var(--light-green); color: white; font-size: 11px; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; padding: 0 5px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; position: absolute; bottom: 0; right: 0; transition: 0.3s; }
        .online { background: #25d366; }
        .offline { background: #bbb; }

        /* Chat Screen Area */
        #chat-screen { position: fixed; inset: 0; background: var(--bg); display: none; flex-direction: column; z-index: 2000; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; padding-bottom: 90px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 14px; position: relative; line-height: 1.4; }
        .sent { align-self: flex-end; background: #e7ffdb; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .received { align-self: flex-start; background: white; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        
        .msg-info { font-size: 10px; text-align: right; opacity: 0.6; margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }
        .tick { font-size: 12px; letter-spacing: -2px; font-weight: bold; }
        .read { color: #34b7f1; }

        /* Input Bar Anti Tab Browser */
        .input-area { background: #f0f0f0; padding: 10px 15px 30px 15px; display: flex; align-items: center; gap: 8px; position: absolute; bottom: 0; width: 100%; border-top: 1px solid #ddd; }
        input[type="text"] { flex: 1; padding: 10px 15px; border: none; border-radius: 20px; outline: none; font-size: 15px; }

        #id-setup-box { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; }
    </style>
</head>
<body>

    <div id="splash">
        <h1 id="welcome-text">Selamat Datang</h1>
        <div id="id-setup-box" style="display:none;">
            <h3>Daftar MyWA</h3>
            <input type="text" id="custom-id-input" placeholder="Masukkan ID Keinginan..." style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ccc; border-radius:8px;">
            <button onclick="registerID()" style="width:100%; padding:12px; background:var(--green); color:white; border:none; border-radius:8px; font-weight:bold;">Mulai Sekarang</button>
        </div>
    </div>

    <div id="notif-pop">
        <div class="avatar" style="width:35px; height:35px; font-size:14px;">!</div>
        <div id="notif-text" style="font-size:14px; color:#333;"></div>
    </div>

    <div id="main-ui">
        <header>
            <span>MyWA Pro</span>
            <span id="my-id-display" style="font-size:12px; opacity:0.8;"></span>
        </header>
        
        <div style="background:white; padding:12px; border-bottom:1px solid #ddd; display:flex; gap:8px;">
            <input type="text" id="target-id" placeholder="ID Teman..." style="flex:2; padding:8px; border:1px solid #ddd; border-radius:5px;">
            <input type="text" id="target-alias" placeholder="Nama..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="handleAddContact()" style="background:var(--green); color:white; border:none; padding:8px 15px; border-radius:5px; font-weight:bold;">Add</button>
        </div>

        <div id="contact-list"></div>
    </div>

    <div id="chat-screen">
        <header>
            <span onclick="closeChat()" style="cursor:pointer; font-size:20px;">‚Üê</span>
            <div class="avatar" id="chat-avatar" style="width:36px; height:36px; font-size:14px;">?</div>
            <div style="flex:1; margin-left:10px;">
                <div id="chat-name" style="font-size:16px;">Nama</div>
                <div id="chat-online-status" style="font-size:10px; opacity:0.8; font-weight:normal;">offline</div>
            </div>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <input type="file" id="file-input" style="display:none" onchange="sendFile()">
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:22px;">üìé</button>
            <input type="text" id="msg-input" placeholder="Ketik pesan..." onfocus="sendReadSignal()">
            <button onclick="sendMsg()" style="background:none; border:none; font-size:28px; color:var(--green);">‚û§</button>
        </div>
    </div>

<script>
    let myId = localStorage.getItem('mywa_id');
    let contacts = JSON.parse(localStorage.getItem('mywa_contacts_v2') || "{}");
    let peer, activeChatId = null;

    // 1. Splash & Setup
    window.onload = () => {
        setTimeout(() => {
            if (!myId) {
                document.getElementById('welcome-text').style.display = 'none';
                document.getElementById('id-setup-box').style.display = 'block';
            } else {
                exitSplash();
            }
        }, 2000);
    };

    function registerID() {
        let val = document.getElementById('custom-id-input').value.trim();
        if (val) {
            localStorage.setItem('mywa_id', val);
            myId = val;
            exitSplash();
        }
    }

    function exitSplash() {
        document.getElementById('splash').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('splash').style.display = 'none';
            initPeer();
        }, 500);
    }

    // 2. Peer Engine
    function initPeer() {
        document.getElementById('my-id-display').innerText = "ID: " + myId;
        peer = new Peer(myId);
        
        peer.on('open', () => {
            setInterval(checkOnlineStatus, 3000);
        });

        peer.on('connection', conn => {
            conn.on('data', data => handleIncomingData(conn.peer, data));
        });

        updateContactListUI();
    }

    // 3. Logic Tambah Kontak (Fixed)
    function handleAddContact() {
        let id = document.getElementById('target-id').value.trim();
        let name = document.getElementById('target-alias').value.trim() || id;
        
        if (id && id !== myId) {
            contacts[id] = { id, alias: name, unread: 0 };
            saveContacts();
            updateContactListUI();
            document.getElementById('target-id').value = "";
            document.getElementById('target-alias').value = "";
            alert("Kontak Berhasil Ditambah!");
        }
    }

    // 4. Chat & Message Logic
    function handleIncomingData(senderId, data) {
        if (!contacts[senderId]) {
            contacts[senderId] = { id: senderId, alias: senderId, unread: 0 };
            saveContacts();
        }

        if (data.type === 'chat' || data.type === 'file') {
            saveHistory(senderId, { ...data, side: 'received' });
            
            if (activeChatId === senderId) {
                renderMessages();
                sendReadSignal(); // Kirim centang biru jika chat dibuka
            } else {
                contacts[senderId].unread = (contacts[senderId].unread || 0) + 1;
                saveContacts();
                updateContactListUI();
                showPopupNotif(senderId, data.msg || "üìé File Baru");
            }
            // Kirim centang 2 (diterima)
            sendSignal(senderId, { type: 'tick', status: 'received', msgId: data.msgId });
        }

        if (data.type === 'tick') {
            updateTickStatus(senderId, data.msgId, data.status);
        }

        if (data.type === 'ping') {
            sendSignal(senderId, { type: 'pong' });
        }

        if (data.type === 'pong') {
            updateStatusDot(senderId, true);
        }
    }

    function sendMsg() {
        let input = document.getElementById('msg-input');
        if (!input.value || !activeChatId) return;

        let msgId = Date.now();
        let data = { type: 'chat', msg: input.value, msgId, time: getTime() };
        
        let conn = peer.connect(activeChatId);
        conn.on('open', () => {
            conn.send(data);
            saveHistory(activeChatId, { ...data, side: 'sent', status: 'sent' });
            renderMessages();
            input.value = "";
        });
    }

    function sendReadSignal() {
        if (activeChatId) {
            sendSignal(activeChatId, { type: 'tick', status: 'read' });
        }
    }

    // 5. UI Helpers
    function updateContactListUI() {
        let list = document.getElementById('contact-list');
        list.innerHTML = "";
        Object.values(contacts).forEach(c => {
            let item = document.createElement('div');
            item.className = 'contact-item';
            item.onclick = () => openChat(c.id);
            item.innerHTML = `
                <div class="avatar">${c.alias[0].toUpperCase()}<div id="dot-${c.id}" class="status-dot offline"></div></div>
                <div style="flex:1"><b>${c.alias}</b><br><small style="color:gray; font-size:10px;">${c.id}</small></div>
                ${c.unread > 0 ? `<div class="badge">${c.unread}</div>` : ''}
            `;
            list.appendChild(item);
        });
    }

    function openChat(id) {
        activeChatId = id;
        contacts[id].unread = 0;
        saveContacts();
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-name').innerText = contacts[id].alias;
        document.getElementById('chat-avatar').innerText = contacts[id].alias[0].toUpperCase();
        sendReadSignal();
        updateContactListUI();
        renderMessages();
    }

    function renderMessages() {
        let container = document.getElementById('messages');
        container.innerHTML = "";
        let history = JSON.parse(localStorage.getItem('h_' + activeChatId) || "[]");
        
        history.forEach(m => {
            let b = document.createElement('div');
            b.className = 'bubble ' + m.side;
            let tickHTML = m.side === 'sent' ? renderTick(m.status) : '';
            
            if (m.type === 'chat') b.innerText = m.msg;
            if (m.type === 'file') b.innerHTML = m.fileType.includes('image') ? `<img src="${m.file}" width="100%">` : `üìÑ ${m.fileName}`;
            
            let info = document.createElement('div');
            info.className = 'msg-info';
            info.innerHTML = `${m.time} ${tickHTML}`;
            b.appendChild(info);
            container.appendChild(b);
        });
        container.scrollTop = container.scrollHeight;
    }

    function renderTick(status) {
        if (status === 'sent') return `<span class="tick">‚úì</span>`;
        if (status === 'received') return `<span class="tick">‚úì‚úì</span>`;
        if (status === 'read') return `<span class="tick read">‚úì‚úì</span>`;
        return '';
    }

    function updateTickStatus(senderId, msgId, status) {
        let history = JSON.parse(localStorage.getItem('h_' + senderId) || "[]");
        history.forEach(m => {
            if (status === 'read' || m.msgId === msgId) m.status = status;
        });
        localStorage.setItem('h_' + senderId, JSON.stringify(history));
        if (activeChatId === senderId) renderMessages();
    }

    function checkOnlineStatus() {
        Object.keys(contacts).forEach(id => {
            sendSignal(id, { type: 'ping' });
            // Set offline dulu, kalau dijawab pong akan jadi online
            setTimeout(() => { if(activeChatId !== id) updateStatusDot(id, false); }, 2000);
        });
    }

    function updateStatusDot(id, isOnline) {
        let dot = document.getElementById('dot-' + id);
        if (dot) dot.className = "status-dot " + (isOnline ? "online" : "offline");
        if (activeChatId === id) document.getElementById('chat-online-status').innerText = isOnline ? "online" : "offline";
    }

    function sendSignal(to, data) {
        let conn = peer.connect(to);
        conn.on('open', () => conn.send(data));
    }

    function saveHistory(id, data) {
        let h = JSON.parse(localStorage.getItem('h_' + id) || "[]");
        h.push(data);
        localStorage.setItem('h_' + id, JSON.stringify(h));
    }

    function showPopupNotif(sender, msg) {
        let p = document.getElementById('notif-pop');
        document.getElementById('notif-text').innerHTML = `<b>${contacts[sender].alias}</b><br>${msg}`;
        p.classList.add('show');
        setTimeout(() => p.classList.remove('show'), 3000);
    }

    function getTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
    function saveContacts() { localStorage.setItem('mywa_contacts_v2', JSON.stringify(contacts)); }
    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChatId = null; }
</script>
</body>
</html>
