<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Pro v28.0 - Irfan & Gemini</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #e5ddd5; --bubble-sent: #dcf8c6; --bubble-received: #ffffff; --text: #000000; --blue: #34b7f1; }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #0b141a; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; }
            .welcome-header, #contact-list, .status-bar, .opening-screen { background: #111b21 !important; color: white; }
            .contact-item { border-bottom: 1px solid #222; }
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }
        
        /* ANIMASI PEMBUKA */
        .opening-screen { position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; transition: 0.8s; }
        .stage { width: 100%; height: 200px; position: relative; overflow: hidden; border-bottom: 2px solid #ccc; }
        .anime { position: absolute; font-size: 50px; bottom: 10px; transition: 0.5s; }
        #char1 { left: 10%; } #char2 { right: 10%; transform: scaleX(-1); }
        .effect { position: absolute; width: 40px; height: 40px; border-radius: 50%; display: none; }
        
        .welcome-header { background: white; text-align: center; padding: 10px; border-bottom: 1px solid #ddd; }
        .status-bar { display: flex; gap: 12px; padding: 10px; overflow-x: auto; background: white; border-bottom: 1px solid #eee; min-height: 90px; }
        .status-circle { min-width: 65px; display: flex; flex-direction: column; align-items: center; font-size: 10px; cursor: pointer; position: relative; }
        .avatar { width: 50px; height: 50px; background: var(--wa-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; border: 2px solid transparent; }
        .status-new { border-color: var(--wa-light) !important; }
        
        #contact-list { flex: 1; overflow-y: auto; background: white; }
        .contact-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; cursor: pointer; position: relative; }
        .online-dot { width: 12px; height: 12px; background: #bbb; border: 2px solid white; border-radius: 50%; position: absolute; left: 50px; bottom: 12px; }
        .is-online { background: var(--wa-light) !important; }
        
        #chat-screen { position: fixed; inset: 0; background: var(--bg); display: none; flex-direction: column; z-index: 4000; }
        header { background: var(--wa-green); color: white; padding: 15px; display: flex; align-items: center; gap: 10px; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: var(--bubble-sent); }
        .received { align-self: flex-start; background: var(--bubble-received); }
        
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
        .btn-download { display: block; color: var(--blue); font-size: 11px; text-decoration: none; margin-top: 5px; font-weight: bold; cursor: pointer; }
        
        .tick { font-size: 12px; margin-left: 5px; color: #888; }
        .tick-blue { color: var(--blue); }
        .fab { position: fixed; bottom: 25px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: var(--wa-light); color: white; border: none; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <div id="opening" class="opening-screen">
        <h3>SELANAT DATANG</h3>
        <p>Irfan & Gemini</p>
        <div class="stage">
            <div id="char1" class="anime">üî•</div>
            <div id="char2" class="anime">‚ö°</div>
            <div id="effect1" class="effect" style="background:orange;"></div>
            <div id="effect2" class="effect" style="background:cyan;"></div>
        </div>
        <p id="loading-text">Menyiapkan Jutsu...</p>
    </div>

    <div id="toast"></div>

    <div id="main-ui">
        <div class="welcome-header">
            <h1 style="margin:0; font-size:18px;">SELANAT DATANG dari Irfan dan Gemini</h1>
            <div id="display-my-id" style="font-size:11px; font-weight:bold; color:var(--wa-green);"></div>
        </div>
        <div class="status-bar" id="status-bar"></div>
        <div id="contact-list"></div>
        <button class="fab" onclick="manualAddContact()">+</button>
    </div>

    <div id="chat-screen">
        <header>
            <span onclick="closeChat()" style="font-size:25px; cursor:pointer">‚Üê</span>
            <div class="avatar" id="chat-avatar" style="width:35px; height:35px; font-size:14px;">?</div>
            <div style="flex:1">
                <div id="chat-title" style="font-weight:bold">Nama</div>
                <small id="chat-online-status">Offline</small>
            </div>
        </header>
        <div id="messages"></div>
        <div style="background:#f0f0f0; padding:10px; display:flex; gap:10px; align-items:center;">
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:20px; cursor:pointer;">üìé</button>
            <input type="file" id="file-input" style="display:none" accept="image/*" onchange="sendFile(this)">
            <input type="text" id="msg-input" placeholder="Ketik pesan..." style="flex:1; padding:10px; border-radius:20px; border:none; outline:none;">
            <button onclick="sendMsg()" style="background:none; border:none; font-size:24px; color:var(--wa-green); cursor:pointer">‚û§</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ID & Inisialisasi
    let myId = localStorage.getItem('mywa_id') || prompt("Masukkan ID Kamu:").trim().toLowerCase();
    localStorage.setItem('mywa_id', myId);
    document.getElementById('display-my-id').innerText = "ID: " + myId;

    // Animasi Pembuka
    window.onload = () => {
        const c1 = document.getElementById('char1');
        const c2 = document.getElementById('char2');
        setTimeout(() => {
            c1.style.left = "40%"; c2.style.right = "40%";
            setTimeout(() => {
                document.getElementById('effect1').style.display = 'block';
                document.getElementById('effect2').style.display = 'block';
                document.getElementById('loading-text').innerText = "BOOM! MyWA Siap.";
                setTimeout(() => {
                    document.getElementById('opening').style.opacity = '0';
                    setTimeout(() => document.getElementById('opening').style.display = 'none', 800);
                }, 1000);
            }, 600);
        }, 500);
    };

    // Status Online & Notifikasi
    db.ref('status/' + myId).set('online');
    db.ref('status/' + myId).onDisconnect().set('offline');

    function notify(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    // Kontak & Chat Diri Sendiri
    let contacts = JSON.parse(localStorage.getItem('mywa_contacts') || "{}");
    contacts[myId] = { id: myId, name: "Saya (Anda)" }; // Pesan ke diri sendiri

    db.ref('inbox/' + myId).on('child_added', snap => {
        let senderId = snap.key;
        if(!contacts[senderId]) {
            contacts[senderId] = { id: senderId, name: "Kontak Baru: " + senderId };
            saveContacts();
            notify("Pesan baru dari " + senderId);
        }
    });

    function saveContacts() {
        localStorage.setItem('mywa_contacts', JSON.stringify(contacts));
        renderContacts();
    }

    function renderContacts() {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        Object.values(contacts).forEach(c => {
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.onclick = () => openChat(c.id, c.name);
            item.innerHTML = `<div class="avatar">${c.name[0].toUpperCase()}</div><div class="online-dot" id="dot-${c.id}"></div><b>${c.name}</b>`;
            list.appendChild(item);
            db.ref('status/' + c.id).on('value', s => {
                let d = document.getElementById('dot-' + c.id);
                if(d) s.val() === 'online' ? d.classList.add('is-online') : d.classList.remove('is-online');
            });
        });
    }

    // Chat Logic
    let activeChatId = null;
    function openChat(id, name) {
        activeChatId = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-title').innerText = name;
        document.getElementById('chat-avatar').innerText = name[0].toUpperCase();
        const chatKey = [myId, id].sort().join("_");
        
        db.ref('chats/' + chatKey).off();
        db.ref('chats/' + chatKey).on('value', snap => {
            const container = document.getElementById('messages');
            container.innerHTML = "";
            let data = snap.val();
            if(data) {
                Object.entries(data).forEach(([key, m]) => {
                    const side = m.sender === myId ? 'sent' : 'received';
                    
                    // Centang Logic
                    let tickClass = "";
                    let ticks = "‚úî"; 
                    if(m.delivered) ticks = "‚úî‚úî";
                    if(m.read) { ticks = "‚úî‚úî"; tickClass = "tick-blue"; }

                    let content = m.type === 'image' 
                        ? `<img src="${m.content}" class="chat-img"><a class="btn-download" onclick="downloadFile('${m.content}', 'IMG.png')">‚¨á Download Gambar</a>` 
                        : m.content;
                    
                    container.innerHTML += `
                        <div class="bubble ${side}">
                            ${content}
                            <div style="font-size:9px; text-align:right; opacity:0.6; margin-top:4px;">
                                ${m.time} <span class="tick ${tickClass}">${ticks}</span>
                            </div>
                        </div>`;
                    
                    if(side === 'received' && !m.read) {
                        db.ref('chats/' + chatKey + '/' + key).update({read: true});
                    }
                });
            }
            container.scrollTop = container.scrollHeight;
        });

        // Set Delivered jika kita online dan buka chat
        db.ref('chats/' + chatKey).once('value', snap => {
            snap.forEach(child => {
                if(child.val().sender !== myId && !child.val().delivered) {
                    child.ref.update({delivered: true});
                }
            });
        });
    }

    function downloadFile(base64, name) {
        const a = document.createElement("a");
        a.href = base64; a.download = name; a.click();
    }

    function sendMsg() {
        const input = document.getElementById('msg-input');
        if (!input.value.trim() || !activeChatId) return;
        pushChat({ type: 'text', content: input.value });
        input.value = "";
    }

    function sendFile(el) {
        const file = el.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const cap = prompt("Tambah caption untuk gambar?");
            pushChat({ type: 'image', content: reader.result, caption: cap || "" });
        };
        reader.readAsDataURL(file);
    }

    function pushChat(data) {
        const chatKey = [myId, activeChatId].sort().join("_");
        db.ref('chats/' + chatKey).push({
            ...data,
            sender: myId,
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            delivered: false,
            read: false
        });
        db.ref('inbox/' + activeChatId + '/' + myId).set(Date.now());
    }

    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChatId = null; }

    // Fitur Status v28 (Gambar + Caption + Viewer)
    function createStatus() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                const cap = prompt("Tulis caption status:");
                const statusData = {
                    id: myId,
                    img: reader.result,
                    text: cap || "",
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now(),
                    viewers: {}
                };
                db.ref('status_updates/' + myId).set(statusData);
                notify("Status berhasil dipasang!");
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    db.ref('status_updates').on('value', snap => {
        const bar = document.getElementById('status-bar');
        bar.innerHTML = `<div class="status-circle" onclick="createStatus()"><div class="avatar" style="background:#bbb">+</div><span>Status</span></div>`;
        snap.forEach(child => {
            const s = child.val();
            if(Date.now() - s.timestamp < 86400000) {
                const isNew = !s.viewers || !s.viewers[myId];
                bar.innerHTML += `
                    <div class="status-circle" onclick="viewStatus('${s.id}')">
                        <div class="avatar ${isNew ? 'status-new' : ''}">${s.id[0].toUpperCase()}</div>
                        <span>${s.id}</span>
                    </div>`;
            }
        });
    });

    function viewStatus(ownerId) {
        db.ref('status_updates/' + ownerId).once('value', snap => {
            const s = snap.val();
            const viewers = s.viewers ? Object.keys(s.viewers).join(", ") : "Belum ada";
            // Catat kita sudah melihat
            if(ownerId !== myId) db.ref('status_updates/' + ownerId + '/viewers/' + myId).set(true);
            
            alert(`STATUS DARI ${ownerId}\n\n[Gambar Terlampir]\nCaption: ${s.text}\nJam: ${s.time}\n\nDilihat oleh: ${viewers}`);
        });
    }

    function manualAddContact() {
        let tid = prompt("Masukkan ID Teman:").trim().toLowerCase();
        if (tid && tid !== myId) {
            let tname = prompt("Nama Panggilan:");
            contacts[tid] = { id: tid, name: tname || tid };
            saveContacts();
        }
    }

    renderContacts();
</script>
</body>
</html>
