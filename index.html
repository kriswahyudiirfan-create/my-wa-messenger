<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SECURE PRIVATE CHAT PRO V45</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #000; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; --blue: #34b7f1; --gold: #ffd700; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); height: 100vh; color: var(--text); overflow: hidden; display: flex; flex-direction: column; }
        
        /* ANIMASI RAINBOW WELCOME */
        @keyframes rainbowText {
            0% { color: #ff0000; } 20% { color: #ff8800; } 40% { color: #ffff00; }
            60% { color: #00ff00; } 80% { color: #0088ff; } 100% { color: #ff00ff; }
        }
        #welcome-display {
            padding: 10px 15px; font-size: 14px; font-weight: 900;
            animation: rainbowText 3s infinite linear;
            text-transform: uppercase; letter-spacing: 1px;
            background: #111b21;
        }

        /* ANIMASI MATA & SLIDE */
        #eye-animation-container {
            height: 0; overflow: hidden; background: #000;
            display: flex; align-items: center; justify-content: center;
            transition: height 0.8s ease-in-out;
        }
        .eye {
            width: 60px; height: 30px; background: #fff; border-radius: 50%;
            position: relative; display: flex; align-items: center; justify-content: center;
        }
        .pupil { width: 20px; height: 20px; background: #000; border-radius: 50%; animation: look 2s infinite; }
        @keyframes look { 0%, 100% { transform: translateX(-10px); } 50% { transform: translateX(10px); } }

        header { background: #111b21; padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        #search-container { padding: 10px; background: #111b21; border-bottom: 1px solid #222; }
        #search-input { width: 100%; background: #2a3942; border: none; padding: 10px 15px; border-radius: 8px; color: #fff; }
        #main-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* LIST STYLE */
        .item-wrapper { position: relative; margin-bottom: 15px; border-radius: 12px; background: #111b21; padding: 2px; overflow: hidden; cursor: pointer; }
        .item-wrapper::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, transparent, transparent, var(--wa-light)); animation: rotateBorder 4s linear infinite; }
        @keyframes rotateBorder { 100% { transform: rotate(360deg); } }
        .contact-content { position: relative; background: #111b21; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px; z-index: 1; }
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* CHAT UI */
        #chat-screen, #call-screen, #pin-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; background: #0b141a; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 14px; color: #fff; }
        .sent { align-self: flex-end; background: var(--bubble-sent); }
        .received { align-self: flex-start; background: var(--bubble-received); }
        .img-msg { max-width: 100%; border-radius: 8px; cursor: pointer; margin-bottom: 5px; }
        .dl-btn { display: block; background: var(--wa-light); color: #000; text-align: center; padding: 5px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-top: 5px; text-decoration: none; }
        
        .input-area { background: #111b21; padding: 12px; display: flex; gap: 10px; }
        .input-area input { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 25px; color: #fff; }
        
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--wa-light); border: none; font-size: 28px; z-index: 100; cursor: pointer; }
        #pin-overlay { display: flex; justify-content: center; align-items: center; z-index: 10001; }
        .pin-input { background: #2a3942; border: 2px solid #444; color: #fff; font-size: 24px; text-align: center; padding: 15px; border-radius: 12px; width: 80%; max-width: 250px; }
    </style>
</head>
<body>

<div id="pin-overlay">
    <div id="pin-ui" style="text-align: center; width: 100%;">
        <div style="font-size: 20px; font-weight: 900; color: var(--wa-light); margin-bottom: 20px;">SECURITY CHECK</div>
        <input type="password" id="pin-field" class="pin-input" placeholder="****" maxlength="6">
        <button onclick="playClick(); verifyPin()" style="margin-top:20px; background:var(--wa-light); border:none; padding:12px 30px; border-radius:8px; font-weight:bold; width: 250px;">MASUK</button>
        <p onclick="createNewIdUI()" style="color:var(--wa-light); margin-top:25px; cursor:pointer;">BUAT ID BARU</p>
        <p onclick="showRecoveryUI()" style="color:#666; font-size:12px; cursor:pointer;">Lupa PIN?</p>
    </div>
    <div id="recovery-ui" style="display: none; text-align: center;">
        <div style="color: var(--gold); font-weight: bold;">RESET AKUN</div>
        <input type="text" id="recovery-field" class="pin-input" style="font-size: 14px;" placeholder="Recovery Key...">
        <button onclick="processRecovery()" style="margin-top:20px; background:var(--gold); border:none; padding:12px 30px; border-radius:8px; width: 250px;">VERIFIKASI</button>
    </div>
</div>

<div id="welcome-display"></div>

<div id="eye-animation-container">
    <div class="eye"><div class="pupil"></div></div>
</div>

<header>
    <div id="header-title" style="font-size: 18px; font-weight: 900; color: var(--wa-light);">DAFTAR KONTAK</div>
    <div id="my-id-display" style="font-size: 11px; color: #666;"></div>
</header>

<div id="search-container">
    <input type="text" id="search-input" placeholder="Cari ID..." oninput="renderList()">
</div>

<div id="main-content">
    <div id="list-container"></div>
</div>

<button class="fab" onclick="addContact()">+</button>

<div id="chat-screen">
    <div style="background:#202c33; padding:12px; display:flex; align-items:center; gap:12px;">
        <span onclick="closeChat()" style="font-size:25px; cursor:pointer;">‚Üê</span>
        <div id="chat-avatar" class="avatar" style="width:40px; height:40px;">?</div>
        <div style="flex:1">
            <div id="chat-name" style="font-weight:bold;">User</div>
            <small id="chat-status-text" style="font-size:11px; color:#aaa;">Offline</small>
        </div>
        <span onclick="initiateCall()" style="cursor:pointer; font-size: 20px;">üìû</span>
    </div>
    <div id="messages"></div>
    <div class="input-area">
        <button onclick="document.getElementById('file-in').click()" style="background:none; border:none; font-size:20px; color:#888;">üìé</button>
        <input type="file" id="file-in" style="display:none" onchange="uploadMedia(this)">
        <input type="text" id="msg-in" placeholder="Ketik pesan..." oninput="handleTyping()">
        <button onclick="sendMsg()" style="background:none; border:none; color:var(--wa-light); font-size:24px;">‚û§</button>
    </div>
</div>

<div id="call-screen" style="justify-content: center; align-items: center;">
    <div id="call-status" style="color:var(--wa-light); margin-bottom:10px;">MENGHUBUNGKAN...</div>
    <div id="call-target-name" style="font-size:24px; font-weight:bold; margin-bottom:50px;">Name</div>
    <div style="display:flex; gap:30px;">
        <button id="btn-answer" onclick="answerCall()" style="display:none; background:var(--wa-light); padding:20px; border-radius:50%; border:none;">üìû</button>
        <button onclick="endCall()" style="background:#ff4b4b; padding:20px; border-radius:50%; border:none;">üìµ</button>
    </div>
    <audio id="remoteAudio" autoplay></audio>
</div>

<audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="snd-ring" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
<audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

<script>
    // Konfigurasi Firebase Anda
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = localStorage.getItem('ninja_v45_id');
    let contacts = JSON.parse(localStorage.getItem('ninja_contacts_v45') || "{}");
    let activeChat = null;
    let localStream, peerConnection;

    function playClick() { document.getElementById('snd-click').currentTime = 0; document.getElementById('snd-click').play(); }

    // --- KEAMANAN & LOGIN ---
    async function initLogin() {
        if (!myId) {
            await registerNewId();
        } else {
            const snap = await db.ref('users/' + myId).once('value');
            if (!snap.exists() || !snap.val().pin) {
                // Paksa Pasang PIN jika belum ada
                let p1 = prompt("Buat PIN Keamanan (6-Digit):");
                if(p1 && p1.length >= 4) {
                    const rk = "RK-" + Math.random().toString(36).substring(2, 9).toUpperCase();
                    alert("SIMPAN RECOVERY KEY ANDA:\n" + rk);
                    await db.ref('users/' + myId).set({
                        pin: CryptoJS.SHA256(p1).toString(),
                        recovery: CryptoJS.SHA256(rk).toString()
                    });
                    location.reload();
                } else { initLogin(); }
            } else {
                document.getElementById('pin-overlay').style.display = 'flex';
            }
        }
    }

    async function registerNewId() {
        let id = prompt("Masukkan ID Baru:").trim().toLowerCase().replace(/\s/g,'');
        if(!id) return initLogin();
        const check = await db.ref('users/' + id).once('value');
        if(check.exists()) { alert("ID Terpakai!"); return registerNewId(); }
        let pin = prompt("Buat PIN:");
        const rk = "RK-" + Math.random().toString(36).substring(2, 9).toUpperCase();
        alert("SIMPAN RECOVERY KEY:\n" + rk);
        await db.ref('users/' + id).set({ pin: CryptoJS.SHA256(pin).toString(), recovery: CryptoJS.SHA256(rk).toString() });
        localStorage.setItem('ninja_v45_id', id);
        location.reload();
    }

    async function verifyPin() {
        const pin = document.getElementById('pin-field').value;
        const snap = await db.ref('users/' + myId).once('value');
        if(snap.val().pin === CryptoJS.SHA256(pin).toString()) {
            document.getElementById('pin-overlay').style.display = 'none';
            document.getElementById('welcome-display').innerText = "SELAMAT DATANG ID: " + myId;
            startApp();
            runEyeAnimation();
        } else { alert("PIN SALAH"); }
    }

    // --- ANIMASI MATA ---
    function runEyeAnimation() {
        const container = document.getElementById('eye-animation-container');
        setTimeout(() => {
            container.style.height = "100px"; // Buka slide & tunjukkan mata
            setTimeout(() => {
                container.style.height = "0"; // Tutup kembali
            }, 3000);
        }, 1000);
    }

    // --- FITUR CHAT & MEDIA ---
    function uploadMedia(el) {
        const file = el.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const type = file.type.startsWith('image') ? 'img' : 'file';
            sendRawMsg(e.target.result, type);
        };
        reader.readAsDataURL(file);
    }

    function sendRawMsg(content, type) {
        const path = 'chats/' + [myId, activeChat].sort().join("_");
        db.ref(path).push({
            s: myId, 
            c: CryptoJS.AES.encrypt(content, [myId, activeChat].sort().join("_") + "SECURE").toString(),
            type: type,
            time: Date.now(),
            read: false
        });
    }

    function sendMsg() {
        const inp = document.getElementById('msg-in');
        if(!inp.value.trim()) return;
        sendRawMsg(inp.value, 'txt');
        inp.value = "";
    }

    function openChat(id, name) {
        activeChat = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-name').innerText = name;
        const path = 'chats/' + [myId, id].sort().join("_");
        db.ref(path).on('value', snap => {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            snap.forEach(m => {
                const d = m.val();
                const isMe = d.s === myId;
                const key = [myId, id].sort().join("_") + "SECURE";
                const decrypted = CryptoJS.AES.decrypt(d.c, key).toString(CryptoJS.enc.Utf8);
                
                let html = "";
                if(d.type === 'img') {
                    html = `<img src="${decrypted}" class="img-msg" onclick="downloadData('${decrypted}', 'image.png')">
                            <a href="${decrypted}" download="image.png" class="dl-btn">Download Gambar</a>`;
                } else if(d.type === 'file') {
                    html = `<div style="padding:10px; background:#333; border-radius:5px;">üìÅ File Dokumen</div>
                            <a href="${decrypted}" download="file" class="dl-btn">Download File</a>`;
                } else {
                    html = decrypted;
                }
                box.innerHTML += `<div class="bubble ${isMe?'sent':'received'}">${html}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function downloadData(url, name) {
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
    }

    // --- LOGIC LAINNYA ---
    function renderList() {
        const container = document.getElementById('list-container');
        container.innerHTML = "";
        Object.values(contacts).forEach(c => {
            const div = document.createElement('div');
            div.className = 'item-wrapper';
            div.innerHTML = `<div class="contact-content">
                <div class="avatar">${c.name[0].toUpperCase()}</div>
                <div style="flex:1">
                    <div style="font-weight:bold;">${c.name}</div>
                    <small id="status-${c.id}">Offline</small>
                </div>
            </div>`;
            div.onclick = () => { playClick(); openChat(c.id, c.name); };
            container.appendChild(div);
            
            db.ref('presence/' + c.id).on('value', s => {
                const el = document.getElementById('status-' + c.id);
                if(el) el.innerText = s.val() === 'online' ? 'Online' : 'Offline';
            });
        });
    }

    function startApp() {
        db.ref('presence/' + myId).onDisconnect().set(Date.now());
        db.ref('presence/' + myId).set('online');
        renderList();
        
        // Listener Panggilan Masuk
        db.ref('calls/' + myId).on('value', snap => {
            const data = snap.val();
            if(data && data.status === 'ringing') {
                document.getElementById('snd-ring').play();
                document.getElementById('call-screen').style.display = 'flex';
                document.getElementById('call-target-name').innerText = data.from;
                document.getElementById('btn-answer').style.display = 'block';
                window.incomingOffer = data.offer;
            }
            if(data && data.status === 'ended') endCall();
        });
    }

    function addContact() {
        let id = prompt("Masukkan ID Teman:").trim().toLowerCase();
        if(id && id !== myId) {
            contacts[id] = {id: id, name: id};
            localStorage.setItem('ninja_contacts_v45', JSON.stringify(contacts));
            renderList();
        }
    }

    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChat = null; }
    function showRecoveryUI() { document.getElementById('pin-ui').style.display = 'none'; document.getElementById('recovery-ui').style.display = 'block'; }
    function createNewIdUI() { if(confirm("Hapus ID ini dan buat baru?")) { localStorage.clear(); location.reload(); } }

    // --- WebRTC (Simple) ---
    async function setupAudio() {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        peerConnection = new RTCPeerConnection();
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
    }

    async function initiateCall() {
        await setupAudio();
        document.getElementById('call-screen').style.display = 'flex';
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        db.ref('calls/' + activeChat).set({ from: myId, status: 'ringing', offer: JSON.stringify(offer) });
    }

    async function answerCall() {
        document.getElementById('snd-ring').pause();
        await setupAudio();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(window.incomingOffer)));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        db.ref('calls/' + myId).update({ status: 'accepted', answer: JSON.stringify(answer) });
        document.getElementById('btn-answer').style.display = 'none';
        document.getElementById('call-status').innerText = "DALAM PANGGILAN";
    }

    function endCall() {
        document.getElementById('snd-ring').pause();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-screen').style.display = 'none';
        if(activeChat) db.ref('calls/' + activeChat).remove();
        db.ref('calls/' + myId).remove();
    }

    initLogin();
</script>
</body>
</html>
