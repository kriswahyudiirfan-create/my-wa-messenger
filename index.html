<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Pro v31.0 - Shinobi Final</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #000000; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; --blue: #34b7f1; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }

        /* ANIMASI STICKMAN NINJA */
        .opening-screen { position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; transition: 1s; }
        .battle-stage { width: 100%; height: 300px; position: relative; overflow: hidden; }
        
        .stickman { position: absolute; bottom: 50px; width: 40px; height: 80px; transition: 0.5s linear; }
        /* Gambar Stickman Sederhana dengan CSS */
        .stickman::before { content: ''; position: absolute; top: 0; left: 10px; width: 20px; height: 20px; border: 3px solid #fff; border-radius: 50%; } /* Kepala */
        .stickman::after { content: ''; position: absolute; top: 23px; left: 20px; width: 3px; height: 30px; background: #fff; } /* Badan */
        .arm { position: absolute; top: 30px; width: 20px; height: 3px; background: #fff; transform-origin: left; }
        .leg { position: absolute; top: 53px; width: 3px; height: 25px; background: #fff; transform-origin: top; }
        
        #n-stick { left: -100px; } 
        #s-stick { right: -100px; }
        #s-stick div, #s-stick::before, #s-stick::after { border-color: #aaf !important; background: #aaf !important; }

        .jutsu { position: absolute; width: 30px; height: 30px; border-radius: 50%; display: none; filter: blur(5px); }
        .rasengan { background: #34b7f1; box-shadow: 0 0 20px #34b7f1; }
        .chidori { background: #fff; box-shadow: 0 0 20px #fff; }

        .clash-fx { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0); width: 100vw; height: 100vw; background: radial-gradient(circle, #fff, #34b7f1, transparent); border-radius: 50%; transition: 0.4s ease-out; z-index: 10; opacity: 0.8; }

        /* UI */
        .welcome-header { background: #111b21; text-align: center; padding: 15px; border-bottom: 1px solid #222; }
        .rainbow-text { font-size: 22px; font-weight: bold; background: linear-gradient(to left, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); -webkit-background-clip: text; color: transparent; background-size: 200% auto; animation: rainbow 3s linear infinite; }
        @keyframes rainbow { to { background-position: 200% center; } }

        #contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 12px 15px; border-bottom: 1px solid #111; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; background: var(--wa-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; }
        .contact-info { flex: 1; cursor: pointer; min-width: 0; }
        .contact-info div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .online-dot { width: 10px; height: 10px; background: #444; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .is-online { background: var(--wa-light) !important; box-shadow: 0 0 5px var(--wa-light); }

        .btn-action { background: none; border: none; font-size: 18px; cursor: pointer; padding: 8px; opacity: 0.7; }
        .btn-action:hover { opacity: 1; }
        .delete-btn { color: #ff5c5c; }
        .edit-btn { color: var(--blue); }

        #chat-screen { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; z-index: 4000; }
        header { background: #202c33; padding: 10px; display: flex; align-items: center; gap: 10px; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #0d0d0d; }
        
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .sent { align-self: flex-end; background: var(--bubble-sent); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--bubble-received); border-bottom-left-radius: 2px; }
        .tick { font-size: 11px; margin-left: 5px; color: #999; }
        .tick-blue { color: var(--blue); }

        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .btn-dl { display: inline-block; color: var(--blue); font-size: 11px; margin-top: 5px; text-decoration: none; border: 1px solid var(--blue); padding: 3px 8px; border-radius: 4px; }

        .fab { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--wa-light); color: white; border: none; font-size: 30px; box-shadow: 0 4px 15px rgba(0,255,100,0.3); cursor: pointer; }
        #toast { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: var(--wa-light); color: black; padding: 10px 20px; border-radius: 30px; font-weight: bold; z-index: 10001; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="opening" class="opening-screen">
        <div class="battle-stage">
            <div id="n-stick" class="stickman">
                <div class="arm" style="transform: rotate(-20deg);"></div>
                <div class="leg" style="transform: rotate(20deg); left:15px;"></div>
                <div class="leg" style="transform: rotate(-20deg); left:22px;"></div>
                <div id="rasengan" class="jutsu rasengan" style="top:25px; left:25px;"></div>
            </div>
            <div id="s-stick" class="stickman">
                <div class="arm" style="transform: rotate(200deg);"></div>
                <div class="leg" style="transform: rotate(20deg); left:15px;"></div>
                <div class="leg" style="transform: rotate(-20deg); left:22px;"></div>
                <div id="chidori" class="jutsu chidori" style="top:25px; right:25px;"></div>
            </div>
            <div id="clash-fx" class="clash-fx"></div>
        </div>
        <h2 id="status-text" style="color:white; margin-top: 20px; letter-spacing: 5px; font-style: italic;">PREPARING CHAKRA...</h2>
    </div>

    <div id="toast"></div>

    <div id="main-ui">
        <div class="welcome-header">
            <div class="rainbow-text">MYWA NINJA PRO</div>
            <div id="my-id-display" style="color: var(--wa-light); font-size: 12px; margin-top: 8px;"></div>
        </div>
        <div id="contact-list"></div>
        <button class="fab" onclick="addContact()">+</button>
    </div>

    <div id="chat-screen">
        <header>
            <span onclick="closeChat()" style="font-size:30px; cursor:pointer; padding: 0 10px;">‚Üê</span>
            <div class="avatar" id="c-avatar" style="width:38px; height:38px; font-size: 14px;">?</div>
            <div style="flex:1; min-width:0;">
                <div id="c-name" style="font-weight:bold; overflow:hidden; text-overflow:ellipsis;">Nama</div>
                <small id="c-status" style="color:#aaa;">Offline</small>
            </div>
        </header>
        <div id="messages"></div>
        <div style="background:#111b21; padding:12px; display:flex; gap:10px; align-items:center;">
            <button onclick="document.getElementById('f-in').click()" style="background:none; border:none; font-size:22px; cursor:pointer;">üìé</button>
            <input type="file" id="f-in" style="display:none" accept="image/*" onchange="upFile(this)">
            <input type="text" id="m-in" placeholder="Ketik pesan..." style="flex:1; padding:12px; border-radius:25px; border:none; background:#2a3942; color:white; outline:none;">
            <button onclick="sendMsg()" style="background:none; border:none; font-size:28px; color:var(--wa-light); cursor:pointer;">‚û§</button>
        </div>
    </div>

<script>
    // --- KONFIGURASI ---
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = localStorage.getItem('mywa_id') || prompt("Masukkan ID Unik Kamu:").trim().toLowerCase();
    if(!myId) myId = "ninja_" + Math.floor(Math.random()*1000);
    localStorage.setItem('mywa_id', myId);
    document.getElementById('my-id-display').innerText = "ID SAYA: " + myId.toUpperCase();

    // Notifikasi
    if (Notification.permission !== "granted") Notification.requestPermission();

    // --- ANIMASI STICKMAN ---
    window.onload = () => {
        const n = document.getElementById('n-stick'), s = document.getElementById('s-stick');
        const r = document.getElementById('rasengan'), ch = document.getElementById('chidori');
        const fx = document.getElementById('clash-fx'), st = document.getElementById('status-text');

        setTimeout(() => { n.style.left = "20%"; s.style.right = "20%"; }, 500);
        setTimeout(() => { r.style.display = 'block'; ch.style.display = 'block'; st.innerText = "CHIDORI vs RASENGAN!"; }, 1500);
        setTimeout(() => { n.style.left = "42%"; s.style.right = "42%"; }, 2500);
        setTimeout(() => { 
            fx.style.transform = "translate(-50%, -50%) scale(2)";
            document.body.style.filter = "invert(1)";
        }, 2900);
        setTimeout(() => {
            document.body.style.filter = "none";
            document.getElementById('opening').style.opacity = '0';
            setTimeout(() => document.getElementById('opening').style.display = 'none', 1000);
        }, 3600);
    };

    // --- LOGIKA UTAMA ---
    let contacts = JSON.parse(localStorage.getItem('mywa_contacts') || "{}");

    // Presence
    db.ref('status/' + myId).set('online');
    db.ref('status/' + myId).onDisconnect().set('offline');

    // Listener Inbox (Auto-Save kontak baru yang ngechat)
    db.ref('inbox/' + myId).on('child_added', snap => {
        let senderId = snap.key;
        if (!contacts[senderId]) {
            contacts[senderId] = { id: senderId, name: "Ninja: " + senderId };
            saveContacts();
            showToast("Pesan dari " + senderId);
            if(Notification.permission === "granted") new Notification("Pesan Baru!", { body: "ID " + senderId + " mengirim pesan." });
        }
    });

    function saveContacts() {
        localStorage.setItem('mywa_contacts', JSON.stringify(contacts));
        renderList();
    }

    function renderList() {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        const sorted = Object.values(contacts);
        
        if(sorted.length === 0) {
            list.innerHTML = "<div style='text-align:center; padding:50px; color:#555;'>Klik + untuk tambah teman</div>";
        }

        sorted.forEach(c => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `
                <div class="avatar">${c.name[0].toUpperCase()}</div>
                <div class="contact-info" onclick="openChat('${c.id}', '${c.name}')">
                    <div style="font-weight:bold; color:#fff;">${c.name}</div>
                    <small><span class="online-dot" id="dot-${c.id}"></span>ID: ${c.id}</small>
                </div>
                <button class="btn-action edit-btn" onclick="editCon('${c.id}')">‚úèÔ∏è</button>
                <button class="btn-action delete-btn" onclick="delCon('${c.id}')">üóëÔ∏è</button>
            `;
            list.appendChild(div);
            // Monitor Online Status
            db.ref('status/' + c.id).on('value', s => {
                const dot = document.getElementById('dot-' + c.id);
                if(dot) s.val() === 'online' ? dot.classList.add('is-online') : dot.classList.remove('is-online');
            });
        });
    }

    function addContact() {
        let id = prompt("Masukkan ID Teman:").trim().toLowerCase();
        if(id && id !== myId) {
            let n = prompt("Nama Panggilan:");
            contacts[id] = { id: id, name: n || id };
            saveContacts();
        }
    }

    function editCon(id) {
        let newName = prompt("Ubah Nama Panggilan:", contacts[id].name);
        if(newName) {
            contacts[id].name = newName;
            saveContacts();
        }
    }

    function delCon(id) {
        if(confirm("Hapus kontak '" + contacts[id].name + "'?")) {
            delete contacts[id];
            saveContacts();
        }
    }

    // --- CHAT SYSTEM ---
    let activeChat = null;
    function openChat(id, name) {
        activeChat = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('c-name').innerText = name;
        document.getElementById('c-avatar').innerText = name[0].toUpperCase();
        
        const key = [myId, id].sort().join("_");
        const msgDiv = document.getElementById('messages');

        db.ref('chats/' + key).off();
        db.ref('chats/' + key).on('value', snap => {
            msgDiv.innerHTML = "";
            snap.forEach(child => {
                const m = child.val();
                const isMe = m.sender === myId;
                const tickColor = m.read ? 'tick-blue' : '';
                const tickSymbol = m.read ? '‚úî‚úî' : (m.delivered ? '‚úî‚úî' : '‚úî');
                
                let content = m.type === 'image' ? 
                    `<img src="${m.content}" class="chat-img"><br><a class="btn-dl" onclick="dlImg('${m.content}')">DOWNLOAD</a>` : m.content;
                
                msgDiv.innerHTML += `
                    <div class="bubble ${isMe?'sent':'received'}">
                        ${content}
                        <div style="font-size:9px; text-align:right; opacity:0.6; margin-top:4px;">
                            ${m.time} ${isMe ? `<span class="tick ${tickColor}">${tickSymbol}</span>` : ''}
                        </div>
                    </div>`;
                if(!isMe && !m.read) child.ref.update({read: true});
            });
            msgDiv.scrollTop = msgDiv.scrollHeight;
        });

        // Set Delivered
        db.ref('chats/' + key).once('value', snap => {
            snap.forEach(c => { if(c.val().sender !== myId && !c.val().delivered) c.ref.update({delivered: true}); });
        });
    }

    function sendMsg() {
        const inp = document.getElementById('m-in');
        if(!inp.value.trim() || !activeChat) return;
        pushMsg({ type: 'text', content: inp.value });
        inp.value = "";
    }

    function upFile(el) {
        const file = el.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => pushMsg({ type: 'image', content: reader.result });
        reader.readAsDataURL(file);
    }

    function pushMsg(data) {
        const key = [myId, activeChat].sort().join("_");
        db.ref('chats/' + key).push({
            ...data, sender: myId, delivered: false, read: false,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        });
        db.ref('inbox/' + activeChat + '/' + myId).set(Date.now()); // Ping inbox teman
    }

    function dlImg(url) { const a = document.createElement('a'); a.href = url; a.download = "Shinobi_IMG.png"; a.click(); }
    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChat = null; }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 3000); }

    // Init Tampilan
    renderList();
</script>
</body>
</html>
