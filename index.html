<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyWA Final Pro v12.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root { --green: #075e54; --light-green: #25d366; --gray: #ededed; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #e5ddd5; overflow: hidden; }
        
        /* Notifikasi Atas */
        #notif-pop { position: fixed; top: -100px; left: 5%; width: 90%; background: var(--white); padding: 10px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; transition: 0.5s; display: flex; align-items: center; gap: 10px; }
        #notif-pop.show { top: 10px; }

        header { background: var(--green); color: white; padding: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; position: sticky; top: 0; z-index: 100; }
        #contact-list { background: var(--white); height: 100vh; overflow-y: auto; }
        .contact-item { padding: 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .avatar { width: 45px; height: 45px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }

        #chat-screen { position: fixed; inset: 0; background: #e5ddd5; display: none; flex-direction: column; z-index: 200; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; word-wrap: break-word; }
        .sent { align-self: flex-end; background: #dcf8c6; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .received { align-self: flex-start; background: var(--white); box-shadow: 0 1px 1px rgba(0,0,0,0.1); }

        .input-area { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; }
        input { flex: 1; padding: 10px; border: none; border-radius: 20px; outline: none; }
        
        /* Layar Telepon */
        #call-screen { position: fixed; inset: 0; background: #075e54; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 500; }
        .call-btns { margin-top: 50px; display: flex; gap: 30px; }
        .btn-call { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-weight: bold; cursor: pointer; }
        .reject { background: #ff3b30; }
    </style>
</head>
<body>

    <div id="notif-pop">
        <div class="avatar" style="width:30px; height:30px; font-size:12px">!</div>
        <div id="notif-text" style="font-size:13px; color:#333"></div>
    </div>

    <div id="main-ui">
        <header>MyWA Pro <span id="my-id-display" style="font-size: 10px; opacity: 0.7;"></span></header>
        <div style="padding: 10px; background: #fff;">
            <input type="text" id="target-id" placeholder="Masukkan ID teman...">
            <button onclick="addContact()" style="background:var(--light-green); border:none; padding:8px; border-radius:5px; color:white;">Tambah</button>
        </div>
        <div id="contact-list"></div>
    </div>

    <div id="chat-screen">
        <header>
            <span onclick="closeChat()" style="cursor:pointer">‚Üê</span>
            <div class="avatar" id="chat-avatar">?</div>
            <span id="chat-name">Teman</span>
            <button onclick="startCall()" style="margin-left:auto; background:none; border:none; color:white; font-size:20px">üìû</button>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Ketik pesan...">
            <button onclick="sendMsg()" style="background:none; border:none; font-size:20px">‚û§</button>
        </div>
    </div>

    <div id="call-screen">
        <div class="avatar" style="width:100px; height:100px; font-size:40px">üìû</div>
        <h2 id="call-status">Memanggil...</h2>
        <h3 id="call-name">Fanisa</h3>
        <div class="call-btns">
            <button class="btn-call reject" onclick="endCall()">Tolak</button>
        </div>
    </div>

<script>
    let myId = localStorage.getItem('mywa_id') || "WA-" + Math.floor(Math.random()*9999);
    localStorage.setItem('mywa_id', myId);
    document.getElementById('my-id-display').innerText = "ID SAYA: " + myId;

    const peer = new Peer(myId);
    let activeChatId = null;
    let connMap = {};

    peer.on('open', id => console.log("Ready: " + id));

    peer.on('connection', conn => {
        setupConn(conn);
    });

    function setupConn(conn) {
        connMap[conn.peer] = conn;
        conn.on('data', data => {
            if(data.type === 'chat') {
                saveMsg(conn.peer, data.msg, 'received');
                showNotification(conn.peer, data.msg);
                if(activeChatId === conn.peer) renderMessages();
                addContactToList(conn.peer); // Pastikan ID muncul di daftar kontak
            }
            if(data.type === 'call_start') {
                document.getElementById('call-screen').style.display = 'flex';
                document.getElementById('call-status').innerText = "Panggilan Masuk...";
                document.getElementById('call-name').innerText = conn.peer;
                activeChatId = conn.peer;
            }
            if(data.type === 'call_end') {
                document.getElementById('call-screen').style.display = 'none';
                alert("Panggilan ditolak/diakhiri.");
            }
        });
    }

    function addContact() {
        let id = document.getElementById('target-id').value;
        if(id && id !== myId) {
            addContactToList(id);
            document.getElementById('target-id').value = "";
        }
    }

    function addContactToList(id) {
        if(document.getElementById('contact-' + id)) return;
        let list = document.getElementById('contact-list');
        let item = document.createElement('div');
        item.id = 'contact-' + id;
        item.className = 'contact-item';
        item.onclick = () => openChat(id);
        item.innerHTML = `<div class="avatar">${id[0]}</div><div><b>${id}</b></div>`;
        list.appendChild(item);
    }

    function openChat(id) {
        activeChatId = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-name').innerText = id;
        document.getElementById('chat-avatar').innerText = id[0];
        if(!connMap[id]) {
            let conn = peer.connect(id);
            setupConn(conn);
        }
        renderMessages();
    }

    function sendMsg() {
        let input = document.getElementById('msg-input');
        if(input.value && activeChatId) {
            let data = { type: 'chat', msg: input.value };
            connMap[activeChatId].send(data);
            saveMsg(activeChatId, input.value, 'sent');
            renderMessages();
            input.value = "";
        }
    }

    function startCall() {
        if(activeChatId) {
            connMap[activeChatId].send({ type: 'call_start' });
            document.getElementById('call-screen').style.display = 'flex';
            document.getElementById('call-status').innerText = "Memanggil...";
            document.getElementById('call-name').innerText = activeChatId;
        }
    }

    function endCall() {
        // Kirim sinyal ke lawan bicara agar panggilannya mati juga
        if(activeChatId && connMap[activeChatId]) {
            connMap[activeChatId].send({ type: 'call_end' });
        }
        document.getElementById('call-screen').style.display = 'none';
    }

    function showNotification(sender, msg) {
        if(activeChatId === sender && document.getElementById('chat-screen').style.display === 'flex') return;
        let pop = document.getElementById('notif-pop');
        document.getElementById('notif-text').innerText = sender + ": " + msg;
        pop.classList.add('show');
        setTimeout(() => pop.classList.remove('show'), 3000);
    }

    function saveMsg(id, msg, type) {
        let history = JSON.parse(localStorage.getItem('chat_' + id) || "[]");
        history.push({ msg, type });
        localStorage.setItem('chat_' + id, JSON.stringify(history));
    }

    function renderMessages() {
        let container = document.getElementById('messages');
        container.innerHTML = "";
        let history = JSON.parse(localStorage.getItem('chat_' + activeChatId) || "[]");
        history.forEach(data => {
            let b = document.createElement('div');
            b.className = 'bubble ' + data.type;
            b.innerText = data.msg;
            container.appendChild(b);
        });
        container.scrollTop = container.scrollHeight;
    }

    function closeChat() {
        document.getElementById('chat-screen').style.display = 'none';
        activeChatId = null;
    }
</script>
</body>
</html>
