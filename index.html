<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Pro v23.0 - Status & Chat</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #e5ddd5; --blue-tick: #34b7f1; --bubble-sent: #dcf8c6; --bubble-received: #ffffff; --text: #000000; }
        
        @media (prefers-color-scheme: dark) {
            :root { --bg: #0b141a; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; }
            .welcome-header, #contact-list, .status-bar { background: #111b21 !important; color: white; }
            .contact-item { border-bottom: 1px solid #222; }
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }

        .welcome-header { background: white; text-align: center; padding: 15px; border-bottom: 1px solid #ddd; }
        .rainbow-text { font-size: 24px; font-weight: 900; margin: 0; background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 3s infinite linear; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* Fitur Status Bar */
        .status-bar { display: flex; gap: 10px; padding: 10px; overflow-x: auto; background: white; border-bottom: 1px solid #eee; min-height: 80px; }
        .status-circle { min-width: 60px; display: flex; flex-direction: column; align-items: center; font-size: 10px; cursor: pointer; }
        .status-thumb { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--wa-light); padding: 2px; object-fit: cover; background: #ccc; }
        .status-thumb.seen { border-color: #bbb; }

        #contact-list { flex: 1; overflow-y: auto; background: white; }
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; cursor: pointer; position: relative; }
        .avatar { width: 45px; height: 45px; background: var(--wa-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-transform: uppercase; }
        
        .unread-badge { background: var(--wa-light); color: white; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin-left: auto; }

        .fab-container { position: fixed; bottom: 30px; right: 25px; display: flex; flex-direction: column; gap: 10px; }
        .fab { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .fab-add { background: var(--wa-light); }
        .fab-status { background: #555; font-size: 18px; }

        /* Overlay Status Viewer */
        #status-viewer { position: fixed; inset: 0; background: black; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .status-content { width: 100%; max-height: 80%; object-fit: contain; }
        .status-text-display { padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }
        .status-meta { position: absolute; top: 20px; left: 20px; display: flex; align-items: center; gap: 10px; }
        .viewer-count { position: absolute; bottom: 20px; font-size: 14px; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; }

        #chat-screen { position: fixed; inset: 0; background: var(--bg); display: none; flex-direction: column; z-index: 4000; }
        header { background: var(--wa-green); color: white; padding: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 15px; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; }
        .sent { align-self: flex-end; background: var(--bubble-sent); }
        .received { align-self: flex-start; background: var(--bubble-received); }
        
        .btn-action { background: none; border: none; font-size: 24px; color: var(--wa-green); cursor: pointer; }
        .input-area { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; }
        #msg-input { flex: 1; padding: 12px; border: none; border-radius: 25px; outline: none; }
    </style>
</head>
<body>

    <div id="main-ui">
        <div class="welcome-header">
            <h1 class="rainbow-text">SELAMAT DATANG</h1>
            <div id="display-my-id" style="font-size:12px; color:var(--wa-green); font-weight:bold;"></div>
        </div>

        <div class="status-bar" id="status-bar">
            <div class="status-circle" onclick="uploadStatus()">
                <div class="avatar" style="width:50px; height:50px;">+</div>
                <span>Status Saya</span>
            </div>
        </div>

        <div id="contact-list"></div>

        <div class="fab-container">
            <button class="fab fab-status" onclick="uploadStatusText()">üìù</button>
            <button class="fab fab-add" onclick="manualAddContact()">+</button>
        </div>
    </div>

    <div id="status-viewer" onclick="closeStatus()">
        <div class="status-meta">
            <div class="avatar" id="sw-user-avatar" style="width:35px; height:35px;">?</div>
            <b id="sw-user-name">Nama</b>
        </div>
        <div id="sw-content-area" style="width:100%; display:flex; justify-content:center;"></div>
        <div class="viewer-count" id="sw-viewers">Dilihat oleh 0</div>
    </div>

    <div id="chat-screen">
        <header>
            <span onclick="closeChat()" style="cursor:pointer; font-size:25px;">‚Üê</span>
            <div class="avatar" id="chat-avatar" style="width:35px; height:35px;">?</div>
            <div style="flex:1">
                <div id="chat-title">Nama</div>
                <small id="chat-status" style="font-size:10px;">Offline</small>
            </div>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <button class="btn-action" onclick="document.getElementById('file-input').click()">üìé</button>
            <input type="file" id="file-input" style="display:none" onchange="sendFile()">
            <input type="text" id="msg-input" placeholder="Ketik pesan..." oninput="handleTyping()">
            <button class="btn-action" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

<script>
    // --- KONFIGURASI ---
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = localStorage.getItem('mywa_id') || prompt("Pilih ID Kamu:");
    if (myId) localStorage.setItem('mywa_id', myId.trim());
    document.getElementById('display-my-id').innerText = "ID: " + myId;

    let activeChatId = null;
    let contacts = JSON.parse(localStorage.getItem('mywa_contacts') || "{}");

    // --- FITUR NOTIFIKASI ---
    if ("Notification" in window) { Notification.requestPermission(); }
    function sendPush(title, body) {
        if (Notification.permission === "granted") new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png' });
    }

    // --- LOGIKA STATUS (SW) ---
    function uploadStatusText() {
        const txt = prompt("Ketik status tulisan kamu:");
        if (txt) saveStatusToDB({ type: 'text', content: txt });
    }

    function uploadStatus() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => saveStatusToDB({ type: 'image', content: reader.result });
            reader.readAsDataURL(file);
        };
        input.click();
    }

    function saveStatusToDB(data) {
        const swRef = db.ref('status_updates/' + myId);
        swRef.set({
            ...data,
            timestamp: Date.now(),
            user: myId
        });
        alert("Status terpasang! Akan hilang dalam 24 jam.");
    }

    // Pantau Status Teman
    db.ref('status_updates').on('value', snap => {
        const bar = document.getElementById('status-bar');
        const allSW = snap.val() || {};
        const now = Date.now();
        
        // Bersihkan status bar kecuali tombol tambah
        bar.innerHTML = `<div class="status-circle" onclick="uploadStatus()"><div class="avatar" style="width:50px; height:50px;">+</div><span>Status Saya</span></div>`;

        Object.keys(allSW).forEach(uid => {
            const sw = allSW[uid];
            // Cek 24 Jam (86400000 ms)
            if (now - sw.timestamp > 86400000) {
                db.ref('status_updates/' + uid).remove();
                return;
            }

            // Jika teman (bukan diri sendiri) baru update, kirim notif
            if (uid !== myId && contacts[uid]) {
                const lastNotif = localStorage.getItem('last_sw_' + uid);
                if (lastNotif != sw.timestamp) {
                    sendPush("Status Baru!", uid + " baru saja memperbarui statusnya.");
                    localStorage.setItem('last_sw_' + uid, sw.timestamp);
                }
            }

            if (contacts[uid] || uid === myId) {
                bar.innerHTML += `
                    <div class="status-circle" onclick="viewStatus('${uid}')">
                        <img src="${sw.type === 'image' ? sw.content : 'https://ui-avatars.com/api/?name='+uid}" class="status-thumb">
                        <span>${uid === myId ? 'Saya' : uid}</span>
                    </div>`;
            }
        });
    });

    function viewStatus(uid) {
        db.ref('status_updates/' + uid).once('value', snap => {
            const sw = snap.val();
            if (!sw) return;

            document.getElementById('status-viewer').style.display = 'flex';
            document.getElementById('sw-user-name').innerText = uid;
            document.getElementById('sw-user-avatar').innerText = uid[0];
            
            const area = document.getElementById('sw-content-area');
            if (sw.type === 'text') {
                area.innerHTML = `<div class="status-text-display">${sw.content}</div>`;
            } else {
                area.innerHTML = `<img src="${sw.content}" class="status-content">`;
            }

            // Tambah saya ke daftar penonton
            if (uid !== myId) {
                db.ref('status_viewers/' + uid + '/' + myId).set(true);
            }

            // Lihat penonton (hanya jika itu status saya)
            const viewerEl = document.getElementById('sw-viewers');
            if (uid === myId) {
                db.ref('status_viewers/' + uid).on('value', vSnap => {
                    const count = vSnap.numChildren() || 0;
                    const names = Object.keys(vSnap.val() || {}).join(', ');
                    viewerEl.innerText = `Dilihat oleh ${count}: ${names}`;
                });
            } else {
                viewerEl.innerText = "";
            }
        });
    }

    function closeStatus() {
        document.getElementById('status-viewer').style.display = 'none';
    }

    // --- LOGIKA CHAT (Lama tapi tetap stabil) ---
    function manualAddContact() {
        let tid = prompt("ID Teman:");
        if (tid && tid !== myId) {
            contacts[tid] = { id: tid, name: tid };
            localStorage.setItem('mywa_contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    function renderContacts() {
        let list = document.getElementById('contact-list');
        list.innerHTML = `<div class="contact-item" onclick="openChat('BOT-CATATAN', 'Bot Simpan')"><div class="avatar">ü§ñ</div><b>Catatan Pribadi</b></div>`;
        Object.values(contacts).forEach(c => {
            list.innerHTML += `<div class="contact-item" onclick="openChat('${c.id}', '${c.name}')">
                <div class="avatar">${c.name[0]}</div>
                <b>${c.name}</b>
                <div class="unread-badge" id="badge-${c.id}" style="display:none">!</div>
            </div>`;
        });
    }

    function openChat(id, name) {
        activeChatId = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-title').innerText = name;
        document.getElementById('chat-avatar').innerText = name[0];
        document.getElementById('badge-'+id).style.display = 'none';
        
        const chatKey = getChatKey(myId, id);
        db.ref('chats/' + chatKey).on('value', snap => renderMessages(snap.val()));
    }

    async function sendMsg() {
        let input = document.getElementById('msg-input');
        if (!input.value.trim() || !activeChatId) return;
        const msgData = {
            sender: myId,
            content: input.value,
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };
        db.ref('chats/' + getChatKey(myId, activeChatId)).push(msgData);
        db.ref('inbox/' + activeChatId + '/' + myId).set(Date.now());
        input.value = "";
    }

    function renderMessages(data) {
        let container = document.getElementById('messages');
        container.innerHTML = "";
        if (data) {
            Object.values(data).forEach(m => {
                let side = m.sender === myId ? 'sent' : 'received';
                container.innerHTML += `<div class="bubble ${side}">${m.content}<div style="font-size:9px; opacity:0.5; text-align:right;">${m.time}</div></div>`;
            });
        }
        container.scrollTop = container.scrollHeight;
    }

    function getChatKey(id1, id2) { return id1 < id2 ? id1 + "_" + id2 : id2 + "_" + id1; }
    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChatId = null; }
    
    renderContacts();
</script>
</body>
</html>
