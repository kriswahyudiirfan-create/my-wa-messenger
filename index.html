<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Pro v30.0 - Ninja Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #000000; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; --blue: #34b7f1; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }

        /* ANIMASI NARUTO */
        .opening-screen { position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; transition: 1s; }
        .battle-stage { width: 100%; height: 300px; position: relative; overflow: hidden; }
        .speed-lines { position: absolute; inset: 0; background: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.05) 41px); animation: speed 0.1s infinite; }
        @keyframes speed { from { transform: translateX(-50px); } to { transform: translateX(50px); } }
        .shinobi { position: absolute; font-size: 70px; bottom: 20px; transition: 0.4s; }
        #naruto { left: -100px; } #sasuke { right: -100px; transform: scaleX(-1); }
        .clash-circle { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0); width: 200px; height: 200px; background: radial-gradient(circle, white, #34b7f1, transparent); border-radius: 50%; transition: 0.6s; z-index: 10; }

        /* UI COMPONENTS */
        .welcome-header { background: #111b21; text-align: center; padding: 15px; border-bottom: 1px solid #222; }
        .rainbow-text { font-size: 22px; font-weight: bold; background: linear-gradient(to left, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff); -webkit-background-clip: text; color: transparent; background-size: 200% auto; animation: rainbow 3s linear infinite; }
        @keyframes rainbow { to { background-position: 200% center; } }

        #contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 15px; border-bottom: 1px solid #111; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; background: var(--wa-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .contact-info { flex: 1; cursor: pointer; }
        .online-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .is-online { background: var(--wa-light) !important; box-shadow: 0 0 5px var(--wa-light); }

        .btn-action { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        .delete-btn { color: #ff5c5c; }
        .edit-btn { color: var(--blue); }

        /* CHAT SCREEN */
        #chat-screen { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; z-index: 4000; }
        header { background: #202c33; padding: 12px; display: flex; align-items: center; gap: 10px; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #000; }
        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; color: white; word-wrap: break-word; }
        .sent { align-self: flex-end; background: var(--bubble-sent); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--bubble-received); border-bottom-left-radius: 2px; }
        .tick { font-size: 11px; margin-left: 5px; color: #aaa; }
        .tick-blue { color: var(--blue); }
        
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid #444; }
        .btn-dl { display: inline-block; color: var(--blue); font-size: 11px; margin-top: 5px; text-decoration: none; border: 1px solid var(--blue); padding: 2px 6px; border-radius: 4px; }

        .fab { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--wa-light); color: white; border: none; font-size: 30px; box-shadow: 0 4px 15px rgba(0,255,100,0.3); z-index: 100; }
        #toast { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--wa-light); color: black; padding: 10px 20px; border-radius: 30px; font-weight: bold; z-index: 10001; display: none; }
    </style>
</head>
<body>

    <div id="opening" class="opening-screen">
        <div class="battle-stage">
            <div class="speed-lines"></div>
            <div id="naruto" class="shinobi">üç•</div>
            <div id="sasuke" class="shinobi">‚ö°</div>
            <div id="clash" class="clash-circle"></div>
        </div>
        <h2 id="jutsu-name" style="color:white; margin-top: 20px; letter-spacing: 3px;">NINJA CHAT</h2>
    </div>

    <div id="toast"></div>

    <div id="main-ui">
        <div class="welcome-header">
            <div class="rainbow-text">SELAMAT DATANG</div>
            <div style="font-size: 10px; color: #888;">dari IRFAN dan Gemini</div>
            <div id="my-id-display" style="color: var(--wa-light); font-size: 12px; margin-top: 5px; font-weight: bold;"></div>
        </div>
        <div id="contact-list"></div>
        <button class="fab" onclick="addContact()">+</button>
    </div>

    <div id="chat-screen">
        <header>
            <span onclick="closeChat()" style="font-size:30px; cursor:pointer">‚Üê</span>
            <div class="avatar" id="c-avatar" style="width:38px; height:38px;">?</div>
            <div style="flex:1">
                <div id="c-name" style="font-weight:bold">Nama</div>
                <small id="c-status" style="color:#aaa;">Offline</small>
            </div>
        </header>
        <div id="messages"></div>
        <div style="background:#111b21; padding:12px; display:flex; gap:10px; align-items:center;">
            <button onclick="document.getElementById('f-in').click()" style="background:none; border:none; font-size:22px;">üìé</button>
            <input type="file" id="f-in" style="display:none" accept="image/*" onchange="upFile(this)">
            <input type="text" id="m-in" placeholder="Ketik pesan..." style="flex:1; padding:12px; border-radius:25px; border:none; background:#2a3942; color:white; outline:none;">
            <button onclick="sendMsg()" style="background:none; border:none; font-size:28px; color:var(--wa-light);">‚û§</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = localStorage.getItem('mywa_id') || prompt("Masukkan ID Unik Kamu:").trim().toLowerCase();
    localStorage.setItem('mywa_id', myId);
    document.getElementById('my-id-display').innerText = "ID ANDA: " + myId.toUpperCase();

    // Notifikasi Izin
    if (Notification.permission !== "granted") Notification.requestPermission();

    // Naruto Animation
    window.onload = () => {
        const n = document.getElementById('naruto'), s = document.getElementById('sasuke'), c = document.getElementById('clash'), j = document.getElementById('jutsu-name');
        setTimeout(() => { n.style.left = "15%"; s.style.right = "15%"; }, 500);
        setTimeout(() => { n.style.left = "40%"; s.style.right = "40%"; j.innerText = "RASENGAN!"; j.style.color = "#34b7f1"; }, 2000);
        setTimeout(() => { 
            c.style.transform = "translate(-50%, -50%) scale(4)"; 
            document.body.style.filter = "invert(1)";
        }, 2400);
        setTimeout(() => {
            document.body.style.filter = "none";
            document.getElementById('opening').style.opacity = '0';
            setTimeout(() => document.getElementById('opening').style.display = 'none', 1000);
        }, 3200);
    };

    // Presence
    db.ref('status/' + myId).set('online');
    db.ref('status/' + myId).onDisconnect().set('offline');

    let contacts = JSON.parse(localStorage.getItem('mywa_contacts') || "{}");

    // LISTENER: Mendeteksi siapapun yang kirim chat ke ID kita
    db.ref('inbox/' + myId).on('child_added', snap => {
        let senderId = snap.key;
        if (!contacts[senderId]) {
            // Auto-save ID baru yang chat kita
            contacts[senderId] = { id: senderId, name: "Ninja: " + senderId };
            save();
            showNotif("Pesan dari ID baru: " + senderId);
        }
    });

    function save() {
        localStorage.setItem('mywa_contacts', JSON.stringify(contacts));
        render();
    }

    function render() {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        Object.values(contacts).forEach(c => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `
                <div class="avatar">${c.name[0].toUpperCase()}</div>
                <div class="contact-info" onclick="openChat('${c.id}', '${c.name}')">
                    <div style="font-weight:bold">${c.name}</div>
                    <small><span class="online-dot" id="dot-${c.id}"></span>ID: ${c.id}</small>
                </div>
                <button class="btn-action edit-btn" onclick="editName('${c.id}')">‚úèÔ∏è</button>
                <button class="btn-action delete-btn" onclick="delCon('${c.id}')">üóëÔ∏è</button>
            `;
            list.appendChild(div);
            db.ref('status/' + c.id).on('value', s => {
                const d = document.getElementById('dot-' + c.id);
                if(d) s.val() === 'online' ? d.classList.add('is-online') : d.classList.remove('is-online');
            });
        });
    }

    function editName(id) {
        let n = prompt("Beri nama khusus untuk ID ini:", contacts[id].name);
        if(n) { contacts[id].name = n; save(); }
    }

    function delCon(id) { if(confirm("Hapus kontak ini?")) { delete contacts[id]; save(); } }

    function addContact() {
        let id = prompt("Masukkan ID Teman:").trim().toLowerCase();
        if(id && id !== myId) {
            let n = prompt("Nama Panggilan:");
            contacts[id] = { id: id, name: n || id };
            save();
        }
    }

    let activeChat = null;
    function openChat(id, name) {
        activeChat = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('c-name').innerText = name;
        document.getElementById('c-avatar').innerText = name[0].toUpperCase();
        const key = [myId, id].sort().join("_");

        db.ref('chats/' + key).off();
        db.ref('chats/' + key).on('value', snap => {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            snap.forEach(child => {
                const m = child.val();
                const isMe = m.sender === myId;
                let tClass = m.read ? 'tick-blue' : (m.delivered ? '' : '');
                let ticks = m.read ? '‚úî‚úî' : (m.delivered ? '‚úî‚úî' : '‚úî');
                
                let html = m.type === 'image' ? 
                    `<img src="${m.content}" class="chat-img"><br><a class="btn-dl" onclick="dl('${m.content}')">DOWNLOAD</a>` : m.content;
                
                box.innerHTML += `
                    <div class="bubble ${isMe?'sent':'received'}">
                        ${html}
                        <div style="font-size:9px; text-align:right; opacity:0.6; margin-top:4px;">
                            ${m.time} ${isMe ? `<span class="tick ${tClass}">${ticks}</span>` : ''}
                        </div>
                    </div>`;
                if(!isMe && !m.read) child.ref.update({read: true});
            });
            box.scrollTop = box.scrollHeight;
        });

        // Mark as delivered
        db.ref('chats/' + key).once('value', snap => {
            snap.forEach(c => { if(c.val().sender !== myId && !c.val().delivered) c.ref.update({delivered: true}); });
        });
    }

    function sendMsg() {
        const i = document.getElementById('m-in');
        if(!i.value.trim() || !activeChat) return;
        push({ type: 'text', content: i.value });
        i.value = "";
    }

    function upFile(el) {
        const f = el.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = () => push({ type: 'image', content: r.result });
        r.readAsDataURL(f);
    }

    function push(data) {
        const key = [myId, activeChat].sort().join("_");
        db.ref('chats/' + key).push({
            ...data, sender: myId, delivered: false, read: false,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        });
        db.ref('inbox/' + activeChat + '/' + myId).set(Date.now());
    }

    function dl(url) { const a = document.createElement('a'); a.href = url; a.download = "MyWA_File.png"; a.click(); }
    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChat = null; }
    function showNotif(txt) {
        const t = document.getElementById('toast'); t.innerText = txt; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
        if(Notification.permission === "granted") new Notification("MyWA Ninja", { body: txt });
    }

    render();
</script>
</body>
</html>
