<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRIVATE CHAT PRO V5 - SECURE COMMUNICATION</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root {
            --primary: #00a884;
            --read-blue: #53bdeb;
            --bg-dark: #111b21;
            --bg-panel: #202c33;
            --bg-chat: #0b141a;
            --text-main: #e9edef;
            --text-dim: #8696a0;
            --bubble-out: #005c4b;
            --bubble-in: #202c33;
            --accent: #d4a373;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Auth Screen */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--bg-panel); padding: 30px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-group { margin-bottom: 20px; }
        input[type="password"], input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2a3942; color: white; text-align: center; }

        /* Header & Info */
        header { background: var(--bg-panel); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .my-id-badge { font-size: 12px; color: var(--primary); background: rgba(0,168,132,0.1); padding: 4px 10px; border-radius: 20px; }

        /* Contact List */
        #contact-list { flex: 1; overflow-y: auto; }
        .contact-item { display: flex; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; position: relative; }
        .contact-item:active { background: #2a3942; }
        .contact-info { flex: 1; margin-left: 12px; }
        .contact-name { font-weight: bold; display: flex; justify-content: space-between; }
        .contact-meta { font-size: 12px; color: var(--text-dim); margin-top: 4px; display: flex; gap: 5px; }
        .last-msg { font-size: 13px; color: var(--text-dim); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        /* Badges */
        .badge-unread { background: var(--primary); color: #000; border-radius: 50%; min-width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; position: absolute; right: 15px; bottom: 15px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }
        .status-online { background: var(--primary); box-shadow: 0 0 5px var(--primary); }

        /* Chat Window */
        #chat-window { position: fixed; inset: 0; background: var(--bg-chat); z-index: 1000; display: none; flex-direction: column; }
        .chat-header { background: var(--bg-panel); padding: 10px 15px; display: flex; align-items: center; gap: 15px; }
        #message-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Bubbles */
        .bubble { max-width: 75%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 14px; word-wrap: break-word; }
        .bubble.sent { align-self: flex-end; background: var(--bubble-out); border-top-right-radius: 2px; }
        .bubble.received { align-self: flex-start; background: var(--bubble-in); border-top-left-radius: 2px; }
        .bubble-time { font-size: 10px; color: rgba(255,255,255,0.6); text-align: right; margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }
        
        /* Checkmark Styles */
        .ticks { font-weight: bold; font-size: 14px; line-height: 1; }
        .ticks.blue { color: var(--read-blue); }

        /* Context Menu (For Delete/Forward) */
        .msg-actions { font-size: 10px; color: var(--primary); cursor: pointer; display: block; margin-bottom: 4px; }

        /* Input Area */
        .input-bar { background: var(--bg-panel); padding: 10px; display: flex; align-items: center; gap: 10px; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 20px; color: white; }

        /* UI Helpers */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: var(--text-dim); }
        .btn-danger { background: #b91c1c; color: white; font-size: 11px; padding: 4px 8px; }
        
        .floating-btn { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); border: none; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card" id="login-ui">
        <h2 id="auth-title">Security Login</h2>
        <div class="input-group">
            <input type="password" id="pin-field" placeholder="Masukkan PIN 6 Digit" maxlength="6">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="handleAuth()">KONFIRMASI</button>
        <div style="margin-top: 15px;">
            <a href="#" onclick="showRecovery()" style="color: var(--primary); font-size: 13px;">Lupa PIN / Recovery?</a><br><br>
            <a href="#" onclick="createNewAccount()" style="color: var(--text-dim); font-size: 12px;">Daftar ID Baru</a>
        </div>
    </div>
</div>

<header>
    <div>
        <div style="font-weight: 900; color: var(--primary);">PRO CHAT</div>
        <div id="my-display-id" class="my-id-badge">ID: Loading...</div>
    </div>
    <button class="btn btn-ghost" onclick="logout()">Keluar</button>
</header>

<div id="contact-list"></div>

<button class="floating-btn" onclick="addNewContact()">+</button>

<div id="chat-window">
    <div class="chat-header">
        <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px;">‚Üê</button>
        <div style="flex:1">
            <div id="active-name" style="font-weight:bold">Nama Kontak</div>
            <div id="active-status" style="font-size:11px; color: var(--primary);">Offline</div>
        </div>
        <button class="btn btn-danger" onclick="clearCurrentChat()">Hapus Semua Chat</button>
    </div>
    <div id="message-container"></div>
    <div id="typing-indicator" style="padding:5px 20px; font-size:11px; color: var(--primary); height: 20px;"></div>
    <div class="input-bar">
        <input type="file" id="file-input" hidden onchange="sendFile()">
        <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:20px;">üìé</button>
        <input type="text" id="msg-input" placeholder="Ketik pesan..." oninput="updateTypingStatus()">
        <button onclick="sendMessage()" style="background:none; border:none; color:var(--primary); font-size:24px;">‚û§</button>
    </div>
</div>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    let myId = localStorage.getItem('pro_chat_id');
    let contacts = JSON.parse(localStorage.getItem('pro_contacts') || "{}");
    let activeChat = null;
    let targetOnlineStatus = {}; // Store online status of contacts

    // --- ENKRIPSI ---
    function getSecretKey(targetId) { return [myId, targetId].sort().join("_") + "APP_v5_SALT"; }
    function encrypt(text, targetId) { return CryptoJS.AES.encrypt(text, getSecretKey(targetId)).toString(); }
    function decrypt(cipher, targetId) {
        try {
            return CryptoJS.AES.decrypt(cipher, getSecretKey(targetId)).toString(CryptoJS.enc.Utf8) || "‚ùå Pesan Terenkripsi";
        } catch(e) { return "‚ùå Pesan Terenkripsi"; }
    }

    // --- AUTH LOGIC ---
    async function handleAuth() {
        const pin = document.getElementById('pin-field').value;
        if(pin.length < 4) return alert("PIN minimal 4 digit");
        const hashPin = CryptoJS.SHA256(pin).toString();

        if (!myId) {
            alert("Silahkan klik 'Daftar ID Baru' terlebih dahulu");
            return;
        }

        const snap = await db.ref('users/' + myId).once('value');
        if (!snap.exists()) {
            if (confirm("ID tidak ditemukan di server. Buat akun baru dengan ID ini?")) {
                const rk = "RK-" + Math.random().toString(36).substr(2,9).toUpperCase();
                await db.ref('users/' + myId).set({ pin: hashPin, recovery: CryptoJS.SHA256(rk).toString() });
                alert("SIMPAN RECOVERY KEY ANDA:\n" + rk);
                enterApp();
            }
        } else {
            if (snap.val().pin === hashPin) enterApp();
            else alert("PIN SALAH!");
        }
    }

    function createNewAccount() {
        let id = prompt("Masukkan ID Unik Baru (Tanpa Spasi):");
        if (!id) return;
        id = id.toLowerCase().trim().replace(/\s+/g, '');
        db.ref('users/' + id).once('value', snap => {
            if (snap.exists()) alert("ID sudah terpakai!");
            else {
                myId = id;
                localStorage.setItem('pro_chat_id', myId);
                document.getElementById('auth-title').innerText = "Buat PIN Baru untuk " + id;
            }
        });
    }

    function enterApp() {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('my-display-id').innerText = "ID: " + myId;
        startPresence();
        listenInbox();
        renderContacts();
    }

    // --- PRESENCE ---
    function startPresence() {
        const pRef = db.ref('presence/' + myId);
        pRef.set('online');
        pRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
    }

    // --- CONTACT MANAGEMENT ---
    function renderContacts() {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        
        Object.keys(contacts).forEach(id => {
            const c = contacts[id];
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `
                <div class="contact-info">
                    <div class="contact-name">
                        <span>${c.name}</span>
                        <button class="btn-danger" onclick="deleteContact('${id}', event)">Hapus</button>
                    </div>
                    <div class="contact-meta">
                        <span>ID: ${id}</span> ‚Ä¢ <span id="st-${id}">Offline</span>
                    </div>
                    <div class="last-msg" id="last-${id}">...</div>
                </div>
                <div id="badge-${id}"></div>
            `;
            div.onclick = () => openChat(id, c.name);
            list.appendChild(div);

            db.ref('presence/' + id).on('value', s => {
                const statusValue = s.val();
                targetOnlineStatus[id] = (statusValue === 'online');
                const el = document.getElementById(`st-${id}`);
                if(!el) return;
                if(statusValue === 'online') el.innerHTML = `<span class="status-dot status-online"></span> Online`;
                else el.innerText = statusValue ? "Aktif: " + new Date(statusValue).toLocaleTimeString() : "Offline";
            });

            const chatPath = [myId, id].sort().join("_");
            db.ref('chats/' + chatPath).limitToLast(1).on('value', snap => {
                snap.forEach(m => {
                    const d = m.val();
                    const text = d.type === 'img' ? "üì∑ Gambar" : decrypt(d.c, id);
                    document.getElementById(`last-${id}`).innerText = text;
                    if(d.s !== myId && !d.read) {
                        document.getElementById(`badge-${id}`).innerHTML = `<div class="badge-unread">!</div>`;
                    }
                });
            });
        });
    }

    function addNewContact() {
        const id = prompt("Masukkan ID Target:").toLowerCase().trim();
        const name = prompt("Beri Nama Kontak:");
        if (id && name) {
            contacts[id] = { name: name };
            localStorage.setItem('pro_contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    function deleteContact(id, e) {
        e.stopPropagation();
        if(confirm("Hapus kontak ini? Chat tidak akan terhapus di server.")) {
            delete contacts[id];
            localStorage.setItem('pro_contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    // --- LOGIKA CENTANG (MESSAGE STATUS) ---
    function getTicksHtml(isMe, read, targetIsOnline) {
        if (!isMe) return ""; // Centang hanya untuk pengirim
        if (read) return `<span class="ticks blue">‚úì‚úì</span>`; // Dibaca (Biru)
        if (targetIsOnline) return `<span class="ticks">‚úì‚úì</span>`; // Online tapi belum buka chat (Abu 2)
        return `<span class="ticks">‚úì</span>`; // Offline (Abu 1)
    }

    // --- CHAT LOGIC ---
    function openChat(id, name) {
        activeChat = id;
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('active-name').innerText = name;
        document.getElementById('badge-' + id).innerHTML = "";
        
        const path = 'chats/' + [myId, id].sort().join("_");
        db.ref(path).off();
        db.ref(path).on('value', snap => {
            const container = document.getElementById('message-container');
            container.innerHTML = "";
            snap.forEach(m => {
                const d = m.val();
                if(d.deletedBy && d.deletedBy === myId) return;

                const isMe = d.s === myId;
                const content = decrypt(d.c, id);
                const time = new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Cek status online target untuk centang
                const targetOnline = targetOnlineStatus[id] || false;
                const ticks = getTicksHtml(isMe, d.read, targetOnline);

                let html = `<div class="bubble ${isMe?'sent':'received'}">`;
                html += `<span class="msg-actions" onclick="deleteMessage('${m.key}')">Hapus</span>`;
                
                if(d.type === 'img') {
                    html += `<img src="${content}" style="max-width:100%; border-radius:8px;"><br>
                             <a href="${content}" download="img.png" style="color:var(--primary); font-size:11px;">Download</a>`;
                } else {
                    html += `<div>${content}</div>`;
                }
                
                html += `<div class="bubble-time">${time} ${ticks}</div></div>`;
                container.innerHTML += html;

                // Tandai sudah dibaca jika kita yang menerima pesan
                if(!isMe && !d.read) db.ref(`${path}/${m.key}`).update({read: true});
            });
            container.scrollTop = container.scrollHeight;
        });

        db.ref(`typing/${id}/${myId}`).on('value', s => {
            document.getElementById('typing-indicator').innerText = s.val() ? "sedang mengetik..." : "";
        });
    }

    function sendMessage() {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !activeChat) return;

        const path = 'chats/' + [myId, activeChat].sort().join("_");
        db.ref(path).push({
            s: myId,
            c: encrypt(inp.value, activeChat),
            type: 'txt',
            time: firebase.database.ServerValue.TIMESTAMP,
            read: false
        });

        db.ref(`inbox/${activeChat}/${myId}`).set(firebase.database.ServerValue.TIMESTAMP);
        inp.value = "";
        db.ref(`typing/${myId}/${activeChat}`).set(false);
    }

    function sendFile() {
        const file = document.getElementById('file-input').files[0];
        if(!file || !activeChat) return;

        const reader = new FileReader();
        reader.onload = () => {
            const path = 'chats/' + [myId, activeChat].sort().join("_");
            db.ref(path).push({
                s: myId,
                c: encrypt(reader.result, activeChat),
                type: 'img',
                time: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
            db.ref(`inbox/${activeChat}/${myId}`).set(firebase.database.ServerValue.TIMESTAMP);
        };
        reader.readAsDataURL(file);
    }

    function deleteMessage(key) {
        if(confirm("Hapus pesan ini untuk saya?")) {
            const path = 'chats/' + [myId, activeChat].sort().join("_") + "/" + key;
            db.ref(path).update({ deletedBy: myId });
        }
    }

    function clearCurrentChat() {
        if(confirm("Hapus semua pesan di percakapan ini?")) {
            const path = 'chats/' + [myId, activeChat].sort().join("_");
            db.ref(path).once('value', snap => {
                snap.forEach(m => {
                    db.ref(path + "/" + m.key).update({ deletedBy: myId });
                });
            });
        }
    }

    function updateTypingStatus() {
        const val = document.getElementById('msg-input').value.length > 0;
        db.ref(`typing/${myId}/${activeChat}`).set(val);
    }

    function listenInbox() {
        db.ref('inbox/' + myId).on('child_added', snap => {
            const senderId = snap.key;
            if(!contacts[senderId]) {
                contacts[senderId] = { name: "ID Asing: " + senderId };
                localStorage.setItem('pro_contacts', JSON.stringify(contacts));
                renderContacts();
            }
            if(activeChat !== senderId) {
                console.log("Pesan baru masuk dari: " + senderId);
            }
        });
    }

    function closeChat() {
        document.getElementById('chat-window').style.display = 'none';
        activeChat = null;
    }

    function logout() {
        if(confirm("Keluar dari aplikasi?")) {
            db.ref('presence/' + myId).set(firebase.database.ServerValue.TIMESTAMP);
            location.reload();
        }
    }

    function showRecovery() {
        const id = prompt("Masukkan ID Anda:");
        const rk = prompt("Masukkan Recovery Key:");
        if(!id || !rk) return;

        db.ref('users/' + id).once('value', snap => {
            const data = snap.val();
            if(snap.exists() && data.recovery === CryptoJS.SHA256(rk).toString()) {
                const newPin = prompt("Masukkan PIN Baru:");
                db.ref('users/' + id).update({ pin: CryptoJS.SHA256(newPin).toString() });
                alert("PIN Berhasil diganti!");
            } else {
                alert("Data tidak cocok!");
            }
        });
    }
</script>
</body>
</html>
