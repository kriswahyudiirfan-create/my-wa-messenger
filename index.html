<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SECURE PRIVATE CHAT PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #000; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; --blue: #34b7f1; --gold: #ffd700; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); height: 100vh; color: var(--text); overflow: hidden; display: flex; flex-direction: column; }
        
        /* ANIMASI WELCOME */
        #welcome-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10001;
            display: flex; align-items: center; justify-content: center;
            transition: all 1s cubic-bezier(0.77, 0, 0.175, 1);
        }
        #welcome-text {
            font-size: 28px; font-weight: 900; color: var(--wa-light);
            transition: all 1s cubic-bezier(0.77, 0, 0.175, 1);
            position: absolute; text-align: center; width: 100%;
        }
        .moved-welcome {
            top: 15px !important; left: 15px !important; transform: translate(0, 0) scale(0.6) !important;
            width: auto !important; text-align: left !important;
        }

        header { background: #111b21; padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; padding-top: 45px; }
        #search-container { padding: 10px; background: #111b21; border-bottom: 1px solid #222; }
        #search-input { width: 100%; background: #2a3942; border: none; padding: 10px 15px; border-radius: 8px; color: #fff; font-size: 14px; }
        #main-content { flex: 1; overflow-y: auto; padding: 15px; position: relative; }
        .item-wrapper { position: relative; margin-bottom: 15px; border-radius: 12px; background: #111b21; padding: 2px; overflow: hidden; cursor: pointer; }
        .item-wrapper::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, transparent, transparent, var(--wa-light)); animation: rotateBorder 4s linear infinite; }
        @keyframes rotateBorder { 100% { transform: rotate(360deg); } }
        .contact-content { position: relative; background: #111b21; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px; z-index: 1; }
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff; text-transform: uppercase; border: 1px solid #444; flex-shrink: 0; }
        
        /* CHAT BUBBLE & NOTIF */
        .unread-badge { width: 12px; height: 12px; background: var(--wa-light); border-radius: 50%; position: absolute; right: 15px; bottom: 15px; box-shadow: 0 0 10px var(--wa-light); }
        .last-msg-preview { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; display: block; margin-top: 2px; }

        #chat-screen, #call-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; background: #0b141a; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 14px; position: relative; color: #fff; line-height: 1.4; display: flex; flex-direction: column; }
        .sent { align-self: flex-end; background: var(--bubble-sent); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--bubble-received); border-bottom-left-radius: 2px; }
        .status-row { display: flex; justify-content: flex-end; align-items: center; gap: 4px; font-size: 10px; margin-top: 4px; color: rgba(255,255,255,0.6); }
        .tick { font-size: 14px; }
        .read { color: var(--blue); }
        .img-msg { max-width: 100%; border-radius: 8px; margin-bottom: 5px; display: block; cursor: pointer; }
        .dl-btn { font-size: 11px; color: #000; background: var(--wa-light); border: none; border-radius: 4px; padding: 6px 10px; margin-top: 5px; cursor: pointer; text-align: center; font-weight: bold; }
        .input-area { background: #111b21; padding: 12px; display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; background: #2a3942; border: none; padding: 12px 18px; border-radius: 25px; color: #fff; font-size: 14px; }
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--wa-light); border: none; font-size: 28px; z-index: 100; box-shadow: 0 5px 15px rgba(0,255,100,0.3); cursor: pointer; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--wa-light); color: #000; padding: 10px 20px; border-radius: 30px; font-weight: bold; z-index: 10002; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        
        #pin-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .pin-input { background: #2a3942; border: 2px solid #444; color: #fff; font-size: 24px; text-align: center; padding: 15px; border-radius: 12px; width: 100%; max-width: 250px; letter-spacing: 5px; }
        
        #call-screen { justify-content: center; align-items: center; background: radial-gradient(circle, #111b21 0%, #000 100%); }
        .call-btn { border: none; padding: 20px; border-radius: 50%; font-size: 24px; cursor: pointer; transition: 0.3s; }
        .del-btn { color: #ff4b4b; background: none; border: 1px solid #444; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer; margin-left: 5px; }
        .edit-btn { color: var(--blue); background: none; border: 1px solid #444; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer; }
        .file-box { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div id="welcome-overlay">
    <div id="welcome-text">SELAMAT DATANG</div>
</div>

<div id="pin-overlay">
    <div id="pin-ui">
        <div style="font-size: 20px; font-weight: 900; color: var(--wa-light); margin-bottom: 20px; letter-spacing: 2px; text-align: center;">SECURITY CHECK</div>
        <input type="password" id="pin-field" class="pin-input" placeholder="****" maxlength="6">
        <button onclick="playClick(); verifyPin()" style="margin-top:20px; background:var(--wa-light); border:none; padding:12px 30px; border-radius:8px; font-weight:bold; width: 100%;">MASUK</button>
        <p onclick="playClick(); createNewIdUI()" style="color:var(--wa-light); font-weight: bold; font-size:14px; margin-top:25px; cursor:pointer; text-align: center; border: 1px dashed var(--wa-light); padding: 10px; border-radius: 8px;">BUAT ID BARU</p>
        <p onclick="playClick(); showRecoveryUI()" style="color:#666; font-size:12px; margin-top:20px; cursor:pointer; text-align: center;">Lupa PIN? (Gunakan Recovery Key)</p>
    </div>
    <div id="recovery-ui" style="display: none; width: 100%; max-width: 300px;">
        <div style="font-size: 18px; font-weight: bold; color: var(--gold); margin-bottom: 10px; text-align: center;">RESET AKUN</div>
        <input type="text" id="recovery-field" class="pin-input" style="letter-spacing: 1px; font-size: 14px;" placeholder="Masukkan Key...">
        <button onclick="playClick(); processRecovery()" style="margin-top:20px; background:var(--gold); border:none; padding:12px 30px; border-radius:8px; font-weight:bold; width: 100%; color: #000;">VERIFIKASI & RESET</button>
        <p onclick="playClick(); hideRecoveryUI()" style="color:#666; font-size:12px; margin-top:20px; cursor:pointer; text-align: center;">Kembali</p>
    </div>
</div>

<div id="toast"></div>

<header>
    <div>
        <div id="header-title" style="font-size: 18px; font-weight: 900; color: var(--wa-light); letter-spacing: 1px;">DAFTAR KONTAK</div>
        <div id="my-id-display" style="font-size: 11px; color: #666; font-weight: bold;"></div>
    </div>
</header>

<div id="search-container">
    <input type="text" id="search-input" placeholder="Cari ID atau nama..." oninput="renderList()">
</div>

<div id="main-content">
    <div id="list-container"></div>
</div>

<button class="fab" onclick="playClick(); addContact()">+</button>

<div id="chat-screen">
    <div style="background:#202c33; padding:12px; display:flex; align-items:center; gap:12px; border-bottom: 1px solid #333;">
        <span onclick="playClick(); closeChat()" style="font-size:25px; cursor:pointer; padding: 5px 10px;">‚Üê</span>
        <div id="chat-avatar" class="avatar" style="width:40px; height:40px;">?</div>
        <div style="flex:1">
            <div id="chat-name" style="font-weight:bold; font-size:15px;">User</div>
            <small id="chat-status-text" style="font-size:11px; color:#aaa;">Offline</small>
        </div>
        <span onclick="playClick(); initiateCall()" style="font-size:22px; cursor:pointer; padding: 10px;">üìû</span>
        <button onclick="playClick(); clearChatHistory()" style="background:none; border:none; color:#ff4b4b; font-size:12px; font-weight: bold;">Clear</button>
    </div>
    <div id="messages"></div>
    <div class="input-area">
        <button onclick="playClick(); document.getElementById('file-in').click()" style="background:none; border:none; font-size:22px; color: #888;">üìé</button>
        <input type="file" id="file-in" style="display:none" onchange="uploadMedia(this)">
        <input type="text" id="msg-in" placeholder="Ketik pesan..." oninput="handleTyping()">
        <button onclick="playClick(); sendMsg()" style="background:none; border:none; color:var(--wa-light); font-size:26px;">‚û§</button>
    </div>
</div>

<div id="call-screen">
    <div id="call-status" style="color:var(--wa-light); margin-bottom:15px; font-weight: bold; letter-spacing: 3px; text-align:center;">MENGHUBUNGKAN...</div>
    <div id="call-target-name" style="font-size:32px; font-weight:900; color:#fff; margin-bottom:60px; text-align:center;">Name</div>
    <div style="display:flex; gap:40px;">
        <button id="btn-answer" onclick="playClick(); answerCall()" style="display:none; background:var(--wa-light);" class="call-btn">üìû</button>
        <button id="btn-end" onclick="playClick(); endCall()" style="background:#ff4b4b;" class="call-btn">üìµ</button>
    </div>
    <audio id="remoteAudio" autoplay style="display:none"></audio>
</div>

<audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="snd-ring" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
<audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = localStorage.getItem('ninja_v45_id');
    let contacts = JSON.parse(localStorage.getItem('ninja_contacts_v45') || "{}");
    let activeChat = null;
    let typingTimeout;
    let localStream = null;
    let peerConnection = null;

    function playClick() { document.getElementById('snd-click').currentTime = 0; document.getElementById('snd-click').play(); }

    function getSecretKey(targetId) { return [myId, targetId].sort().join("_") + "SECURE_NINJA_v45"; }
    function encrypt(text, targetId) { return CryptoJS.AES.encrypt(text, getSecretKey(targetId)).toString(); }
    function decrypt(cipherText, targetId) {
        try { return CryptoJS.AES.decrypt(cipherText, getSecretKey(targetId)).toString(CryptoJS.enc.Utf8); } 
        catch(e) { return "‚ùå Pesan Terenkripsi"; }
    }

    // --- ANIMASI & LOGIN ---
    async function initLogin() {
        const wt = document.getElementById('welcome-text');
        const wo = document.getElementById('welcome-overlay');
        
        // Animasi Teks Welcome
        setTimeout(() => {
            if(myId) wt.innerText = "SELAMAT DATANG ID: " + myId.toUpperCase();
            wt.classList.add('moved-welcome');
            wo.style.background = "transparent";
            wo.style.pointerEvents = "none";
        }, 2000);

        if (!myId) {
            await handleNewRegistration();
        } else { 
            // CEK APAKAH ID LAMA PUNYA PIN (KEAMANAN TOTAL)
            const snap = await db.ref('users/' + myId).once('value');
            if (!snap.exists() || !snap.val().pin) {
                alert("Keamanan Diperbarui! Silahkan buat PIN untuk ID Anda.");
                let newPin = prompt("Buat PIN 6-Digit Baru:");
                if(newPin && newPin.length >= 4) {
                    const recoveryKey = "RK-" + Math.random().toString(36).substring(2, 10).toUpperCase();
                    alert("SIMPAN RECOVERY KEY:\n\n" + recoveryKey);
                    await db.ref('users/' + myId).set({ 
                        pin: CryptoJS.SHA256(newPin).toString(), 
                        recovery: CryptoJS.SHA256(recoveryKey).toString() 
                    });
                    location.reload();
                } else { initLogin(); }
            } else {
                document.getElementById('pin-overlay').style.display = 'flex'; 
            }
        }
    }

    async function handleNewRegistration() {
        let choice = prompt("Masukkan ID Baru Anda:").trim().toLowerCase().replace(/\s+/g, '');
        if (!choice) return initLogin();
        const check = await db.ref('users/' + choice).once('value');
        if(check.exists()) {
            alert("ID sudah digunakan!");
            return handleNewRegistration();
        } else {
            let newPin = prompt("Buat PIN 6-Digit:");
            if(!newPin || newPin.length < 4) { alert("PIN tidak valid!"); return handleNewRegistration(); }
            const recoveryKey = "RK-" + Math.random().toString(36).substring(2, 10).toUpperCase();
            alert("SIMPAN RECOVERY KEY INI:\n\n" + recoveryKey);
            myId = choice; 
            localStorage.setItem('ninja_v45_id', myId);
            await db.ref('users/' + myId).set({ pin: CryptoJS.SHA256(newPin).toString(), recovery: CryptoJS.SHA256(recoveryKey).toString() });
            location.reload();
        }
    }

    function createNewIdUI() {
        if(confirm("Buat ID baru? Sesi lama akan dihapus.")) {
            localStorage.removeItem('ninja_v45_id');
            localStorage.removeItem('ninja_contacts_v45');
            location.reload();
        }
    }

    async function verifyPin() {
        const pinInput = document.getElementById('pin-field').value;
        const snap = await db.ref('users/' + myId).once('value');
        if (snap.val() && snap.val().pin === CryptoJS.SHA256(pinInput).toString()) {
            document.getElementById('pin-overlay').style.display = 'none';
            document.getElementById('my-id-display').innerText = "ID: " + myId.toUpperCase();
            setupPresence();
            startApp();
        } else { alert("PIN SALAH!"); }
    }

    function showRecoveryUI() { document.getElementById('pin-ui').style.display = 'none'; document.getElementById('recovery-ui').style.display = 'block'; }
    function hideRecoveryUI() { document.getElementById('pin-ui').style.display = 'block'; document.getElementById('recovery-ui').style.display = 'none'; }

    async function processRecovery() {
        const key = document.getElementById('recovery-field').value.trim();
        const snap = await db.ref('users/' + myId).once('value');
        if (snap.val() && snap.val().recovery === CryptoJS.SHA256(key).toString()) {
            let nPin = prompt("Buat PIN Baru:");
            if(nPin) {
                await db.ref('users/' + myId).update({ pin: CryptoJS.SHA256(nPin).toString() });
                alert("Berhasil!"); location.reload();
            }
        } else { alert("Key Salah!"); }
    }

    // --- RENDER LIST DENGAN PREVIEW & BUKET IJO ---
    function renderList() {
        const container = document.getElementById('list-container');
        const search = document.getElementById('search-input').value.toLowerCase();
        container.innerHTML = "";
        Object.values(contacts).forEach(c => {
            if (c.id.includes(search) || c.name.toLowerCase().includes(search)) {
                const div = document.createElement('div');
                div.className = 'item-wrapper';
                div.innerHTML = `<div class="contact-content">
                    <div class="avatar">${c.name[0]}</div>
                    <div style="flex:1">
                        <div style="font-weight:bold; font-size:15px; display:flex; justify-content:space-between;">
                            ${c.name} 
                            <div><button class="edit-btn" onclick="playClick(); editName(event,'${c.id}')">Nama</button>
                            <button class="del-btn" onclick="playClick(); delContact(event,'${c.id}')">Hapus</button></div>
                        </div>
                        <small id="list-status-${c.id}" style="color:#aaa;">Offline</small>
                        <span class="last-msg-preview" id="last-msg-${c.id}">...</span>
                    </div>
                    <div id="unread-${c.id}" style="display:none" class="unread-badge"></div>
                </div>`;
                div.onclick = () => { playClick(); openChat(c.id, c.name); };
                container.appendChild(div);

                // Preview Pesan Terakhir & Buket Ijo
                const path = 'chats/' + [myId, c.id].sort().join("_");
                db.ref(path).limitToLast(1).on('value', snap => {
                    snap.forEach(m => {
                        const d = m.val();
                        const p = document.getElementById(`last-msg-${c.id}`);
                        const u = document.getElementById(`unread-${c.id}`);
                        if(p) p.innerText = (d.type==='txt' ? decrypt(d.c, c.id) : "Lampiran File");
                        if(u && !d.read && d.s !== myId) u.style.display = 'block';
                        else if(u) u.style.display = 'none';
                    });
                });

                // Status Online & Mengetik
                db.ref('presence/' + c.id).on('value', s => {
                    const el = document.getElementById(`list-status-${c.id}`);
                    if(!el) return;
                    db.ref(`typing/${c.id}/${myId}`).on('value', t => {
                        if (t.val()) { el.innerText = "Sedang mengetik..."; el.style.color = "var(--wa-light)"; }
                        else { el.innerText = formatTime(s.val()); el.style.color = (s.val()==='online'?"var(--wa-light)":"#aaa"); }
                    });
                });
            }
        });
    }

    // --- FUNGSI LAIN (TETAP SAMA) ---
    function formatTime(ts) { if (ts === 'online') return 'Online'; const d = new Date(ts); return `Terakhir dilihat ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
    function setupPresence() { const myRef = db.ref('presence/' + myId); db.ref('.info/connected').on('value', s => { if (s.val()) { myRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP); myRef.set('online'); } }); }
    function editName(e, id) { e.stopPropagation(); let n = prompt("Nama baru:", contacts[id].name); if(n){ contacts[id].name=n; saveC(); renderList(); }}
    function delContact(e, id) { e.stopPropagation(); if(confirm("Hapus?")){ delete contacts[id]; saveC(); renderList(); }}
    function addContact() { let id = prompt("ID Teman:").trim().toLowerCase(); if(id && id!==myId){ contacts[id]={id, name:id}; saveC(); renderList(); }}
    function saveC() { localStorage.setItem('ninja_contacts_v45', JSON.stringify(contacts)); }

    function openChat(id, name) {
        activeChat = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-avatar').innerText = name[0];
        const path = 'chats/' + [myId, id].sort().join("_");
        db.ref(path).off();
        db.ref(path).on('value', snap => {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            snap.forEach(m => {
                const d = m.val(); const isMe = d.s === myId;
                const realContent = decrypt(d.c, id);
                let contentUI = (d.type === 'img' ? `<img src="${realContent}" class="img-msg" onclick="downloadFile('${realContent}', 'IMG.png')">` : (d.type==='file' ? `üìÅ File` : realContent));
                box.innerHTML += `<div class="bubble ${isMe?'sent':'received'}">${contentUI}<div class="status-row"><span class="tick ${d.read?'read':''}">${isMe?(d.read?'‚úì‚úì':'‚úì'):''}</span></div></div>`;
                if(!isMe && !d.read) db.ref(`${path}/${m.key}`).update({read:true});
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function sendMsg() {
        const inp = document.getElementById('msg-in');
        if(!inp.value.trim() || !activeChat) return;
        const path = 'chats/' + [myId, activeChat].sort().join("_");
        db.ref(path).push({ s: myId, c: encrypt(inp.value, activeChat), type: 'txt', time: Date.now(), read: false });
        db.ref('inbox/' + activeChat + '/' + myId).set(Date.now());
        inp.value = "";
    }

    // --- WebRTC & Audio Logic Tetap Sama Sesuai Kode Asli ---
    // (setupAudio, initiateCall, answerCall, dll tidak berubah)
    async function setupAudio() { localStream = await navigator.mediaDevices.getUserMedia({ audio: true }); peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }); localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream)); peerConnection.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0]; }
    async function initiateCall() { if (!activeChat) return; document.getElementById('snd-ring').play(); await setupAudio(); document.getElementById('call-screen').style.display = 'flex'; document.getElementById('call-target-name').innerText = activeChat; const callRef = db.ref('calls/' + activeChat); const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); callRef.set({ from: myId, status: 'ringing', offer: JSON.stringify(offer) }); callRef.on('value', async snap => { const data = snap.val(); if (data && data.answer) { document.getElementById('snd-ring').pause(); await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.answer))); document.getElementById('call-status').innerText = "TERHUBUNG"; } if (data && data.status === 'ended') handleCallTermination("PANGGILAN SELESAI"); }); }
    function showIncomingCall(from, data) { document.getElementById('snd-ring').play(); document.getElementById('call-screen').style.display = 'flex'; document.getElementById('call-target-name').innerText = from; document.getElementById('call-status').innerText = "PANGGILAN MASUK..."; document.getElementById('btn-answer').style.display = 'block'; window.incomingOffer = data.offer; }
    async function answerCall() { document.getElementById('snd-ring').pause(); await setupAudio(); await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(window.incomingOffer))); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); db.ref('calls/' + myId).update({ status: 'accepted', answer: JSON.stringify(answer) }); document.getElementById('call-status').innerText = "TERHUBUNG"; document.getElementById('btn-answer').style.display = 'none'; }
    function endCall() { document.getElementById('snd-ring').pause(); const target = activeChat || document.getElementById('call-target-name').innerText; db.ref('calls/' + target).update({ status: 'ended' }); db.ref('calls/' + myId).update({ status: 'ended' }); setTimeout(() => { db.ref('calls/' + target).remove(); db.ref('calls/' + myId).remove(); }, 1000); handleCallTermination("DIAKHIRI"); }
    function handleCallTermination(msg) { document.getElementById('snd-ring').pause(); if (localStream) localStream.getTracks().forEach(t => t.stop()); if (peerConnection) peerConnection.close(); document.getElementById('call-status').innerText = msg; setTimeout(() => { document.getElementById('call-screen').style.display = 'none'; }, 1500); }

    function startApp() {
        db.ref('calls/' + myId).on('value', snap => {
            const data = snap.val();
            if (data && data.status === 'ringing') showIncomingCall(data.from, data);
            if (data && data.status === 'ended') handleCallTermination("PANGGILAN BERAKHIR");
        });
        db.ref('inbox/' + myId).on('child_added', s => {
            if (!contacts[s.key]) { contacts[s.key] = {id: s.key, name: s.key}; saveC(); renderList(); }
            if (activeChat !== s.key) {
                document.getElementById('snd-msg').play();
                showToast("Pesan Baru: " + s.key);
            }
        });
        renderList();
    }

    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChat = null; }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }
    function handleTyping() { if(!activeChat) return; db.ref(`typing/${myId}/${activeChat}`).set(true); clearTimeout(typingTimeout); typingTimeout = setTimeout(() => db.ref(`typing/${myId}/${activeChat}`).set(false), 2000); }
    function clearChatHistory() { if(confirm("Hapus chat?")) db.ref('chats/'+[myId, activeChat].sort().join("_")).remove(); }
    function downloadFile(dataUrl, fileName) { const link = document.createElement('a'); link.href = dataUrl; link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    initLogin();
</script>
</body>
</html>
