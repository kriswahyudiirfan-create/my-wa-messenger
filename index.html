<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Ninja v33.0 - Infinite</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #000; --bubble-sent: #005c4b; --bubble-received: #202c33; --text: #e9edef; --blue: #34b7f1; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        /* INTRO ANIMATION */
        #opening { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .brand-container { display: flex; gap: 40px; font-size: 24px; font-weight: bold; }
        #g-text { color: #4285F4; opacity: 0; transform: translateX(-50px); transition: 1s; }
        #gem-text { color: #8E75FF; opacity: 0; transform: translateX(50px); transition: 1s; }

        /* NEON BORDER ANIMATION */
        @keyframes borderFlow {
            0% { stroke-dashoffset: 1000; opacity: 1; }
            80% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: 0; opacity: 0; }
        }
        .border-svg { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .border-path { fill: none; stroke: var(--wa-light); stroke-width: 2; stroke-linecap: round; stroke-dasharray: 200, 800; animation: borderFlow 4s linear infinite; }

        /* UI STRUKTUR */
        header { background: #111b21; padding: 15px; border-bottom: 1px solid #222; }
        .tabs { display: flex; background: #111b21; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab.active { color: var(--wa-light); border-bottom-color: var(--wa-light); }

        #main-content { flex: 1; overflow-y: auto; padding: 10px; position: relative; }
        .item-card { position: relative; background: #111b21; margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
        .contact-item, .status-item { padding: 15px; display: flex; align-items: center; gap: 12px; position: relative; z-index: 2; }
        
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .typing-txt { color: var(--wa-light); font-size: 11px; font-style: italic; }

        /* CHAT SYSTEM */
        #chat-screen, #status-view { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; background: #0b141a; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; }
        .sent { align-self: flex-end; background: var(--bubble-sent); }
        .received { align-self: flex-start; background: var(--bubble-received); }
        .tick { font-size: 12px; margin-left: 5px; }

        .fab { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--wa-light); color: white; border: none; font-size: 30px; z-index: 100; cursor: pointer; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--wa-light); color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; display: none; z-index: 10000; }
    </style>
</head>
<body>

<div id="opening">
    <div class="brand-container">
        <span id="g-text">Google</span>
        <span id="gem-text">Gemini</span>
    </div>
</div>

<div id="toast"></div>

<header>
    <div style="font-size: 20px; font-weight: bold; color: var(--wa-light);">MyWA Ninja v33.0</div>
    <div id="my-id-display" style="font-size: 11px; color: #888; margin-top: 4px;"></div>
</header>

<div class="tabs">
    <div class="tab active" onclick="switchTab('chats')">CHATS</div>
    <div class="tab" onclick="switchTab('status')">STATUS</div>
</div>

<div id="main-content">
    <div id="list-container"></div>
</div>

<button id="main-fab" class="fab" onclick="handleFab()">+</button>

<div id="chat-screen">
    <div style="background:#202c33; padding:10px; display:flex; align-items:center; gap:10px;">
        <span onclick="closeChat()" style="font-size:25px; cursor:pointer;">‚Üê</span>
        <div id="chat-avatar" class="avatar" style="width:35px; height:35px;">?</div>
        <div style="flex:1">
            <div id="chat-name" style="font-weight:bold;">Name</div>
            <small id="chat-status-sub" style="color:#aaa;">Offline</small>
        </div>
    </div>
    <div id="messages"></div>
    <div style="background:#111b21; padding:10px; display:flex; gap:10px; align-items:center;">
        <button onclick="document.getElementById('file-in').click()" style="background:none; border:none; font-size:20px; cursor:pointer;">üìé</button>
        <input type="file" id="file-in" style="display:none" onchange="upImg(this)">
        <input type="text" id="msg-in" placeholder="Ketik pesan..." oninput="handleTyping()" style="flex:1; background:#2a3942; border:none; padding:10px; border-radius:20px; color:#fff; outline:none;">
        <button onclick="sendMsg()" style="background:none; border:none; color:var(--wa-light); font-size:25px;">‚û§</button>
    </div>
</div>

<div id="status-view" onclick="this.style.display='none'">
    <div style="padding:20px; text-align:center; height:100%; display:flex; flex-direction:column; justify-content:center;">
        <div id="sw-author" style="font-weight:bold; color:var(--wa-light); margin-bottom:10px;"></div>
        <div id="sw-text" style="font-size:24px; word-break:break-word;"></div>
    </div>
</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
        authDomain: "mywa-irfank.firebaseapp.app",
        databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
        projectId: "mywa-irfank",
        storageBucket: "mywa-irfank.firebasestorage.app",
        messagingSenderId: "567484997979",
        appId: "1:567484997979:web:743ea53391552dfde07a7e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- USER IDENTIFICATION ---
    let myId = localStorage.getItem('mywa_id') || prompt("Masukkan ID Unik Kamu:").trim().toLowerCase();
    localStorage.setItem('mywa_id', myId);
    document.getElementById('my-id-display').innerText = "ID: " + myId.toUpperCase();

    let contacts = JSON.parse(localStorage.getItem('mywa_contacts') || "{}");
    let currentTab = 'chats';
    let activeChat = null;
    let typingTimeout;

    // --- ANIMASI PEMBUKA ---
    window.onload = () => {
        const g = document.getElementById('g-text'), gem = document.getElementById('gem-text');
        setTimeout(() => { g.style.opacity = 1; g.style.transform = 'translateX(0)'; }, 300);
        setTimeout(() => { gem.style.opacity = 1; gem.style.transform = 'translateX(0)'; }, 600);
        setTimeout(() => { document.getElementById('opening').style.opacity = 0; 
            setTimeout(() => document.getElementById('opening').style.display = 'none', 800);
        }, 1800);
    };

    // --- CORE LOGIC ---
    db.ref('status/' + myId).set('online');
    db.ref('status/' + myId).onDisconnect().set('offline');

    // Listener Inbox Otomatis
    db.ref('inbox/' + myId).on('child_added', snap => {
        let senderId = snap.key;
        if (!contacts[senderId]) {
            contacts[senderId] = { id: senderId, name: senderId };
            saveCon();
            notify("Pesan", senderId);
        }
    });

    function saveCon() {
        localStorage.setItem('mywa_contacts', JSON.stringify(contacts));
        if(currentTab === 'chats') renderChats();
    }

    function renderChats() {
        const container = document.getElementById('list-container');
        container.innerHTML = "";
        Object.values(contacts).forEach(c => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <svg class="border-svg"><rect class="border-path" x="0" y="0" width="100%" height="100%" rx="8"/></svg>
                <div class="contact-item">
                    <div class="avatar">${c.name[0].toUpperCase()}</div>
                    <div style="flex:1" onclick="openChat('${c.id}', '${c.name}')">
                        <div style="font-weight:bold">${c.name}</div>
                        <small id="sub-${c.id}">Offline</small>
                    </div>
                    <button onclick="editCon('${c.id}')" style="background:none; border:none; color:var(--blue); cursor:pointer;">‚úèÔ∏è</button>
                    <button onclick="delCon('${c.id}')" style="background:none; border:none; color:red; cursor:pointer;">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(card);
            
            // Monitor Online & Typing
            db.ref('status/' + c.id).on('value', s => {
                const sub = document.getElementById('sub-' + c.id);
                if(sub) sub.innerText = s.val() === 'online' ? 'Online' : 'Offline';
            });
            db.ref('typing/' + c.id + '/' + myId).on('value', s => {
                const sub = document.getElementById('sub-' + c.id);
                if(sub) {
                    if(s.val() === true) sub.innerHTML = '<span class="typing-txt">sedang mengetik...</span>';
                    else db.ref('status/' + c.id).once('value', ss => { sub.innerText = ss.val() || 'Offline'; });
                }
            });
        });
    }

    function editCon(id) {
        let n = prompt("Beri Nama Khusus:", contacts[id].name);
        if(n) { contacts[id].name = n; saveCon(); }
    }

    function delCon(id) {
        if(confirm("Hapus kontak ini?")) { delete contacts[id]; saveCon(); }
    }

    // --- CHAT SYSTEM ---
    function openChat(id, name) {
        activeChat = id;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-avatar').innerText = name[0].toUpperCase();
        
        const key = [myId, id].sort().join("_");
        const box = document.getElementById('messages');

        db.ref('chats/' + key).off();
        db.ref('chats/' + key).on('value', snap => {
            box.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const isMe = m.sender === myId;
                
                // Logika Centang
                let tick = '‚úì'; // Default Centang 1
                let tickColor = '#888';
                if(m.delivered) tick = '‚úì‚úì'; 
                if(m.read) { tick = '‚úì‚úì'; tickColor = var(--blue); }

                let content = m.type === 'image' ? `<img src="${m.content}" style="max-width:200px; border-radius:8px;"><br><a href="${m.content}" download="Shinobi_Img" style="color:var(--blue); font-size:10px;">DOWNLOAD</a>` : m.content;
                
                box.innerHTML += `
                    <div class="bubble ${isMe?'sent':'received'}">
                        ${content}
                        <div style="font-size:9px; text-align:right; opacity:0.6; margin-top:4px;">
                            ${m.time} ${isMe ? `<span class="tick" style="color:${tickColor}">${tick}</span>` : ''}
                        </div>
                    </div>`;
                if(!isMe && !m.read) c.ref.update({read: true});
            });
            box.scrollTop = box.scrollHeight;
        });

        // Set Delivered jika target sedang online
        db.ref('status/' + id).on('value', s => {
            if(s.val() === 'online') {
                db.ref('chats/' + key).once('value', snap => {
                    snap.forEach(c => { if(c.val().sender !== id && !c.val().delivered) c.ref.update({delivered: true}); });
                });
            }
        });
    }

    function handleTyping() {
        if(!activeChat) return;
        db.ref('typing/' + myId + '/' + activeChat).set(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            db.ref('typing/' + myId + '/' + activeChat).set(false);
        }, 2000);
    }

    function sendMsg() {
        const i = document.getElementById('msg-in');
        if(!i.value.trim() || !activeChat) return;
        
        // Cek apakah teman online untuk set delivered
        db.ref('status/' + activeChat).once('value', s => {
            const isOnline = s.val() === 'online';
            const key = [myId, activeChat].sort().join("_");
            db.ref('chats/' + key).push({
                content: i.value,
                type: 'text',
                sender: myId,
                delivered: isOnline,
                read: false,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            db.ref('inbox/' + activeChat + '/' + myId).set(Date.now());
            i.value = "";
            db.ref('typing/' + myId + '/' + activeChat).set(false);
        });
    }

    // --- STATUS SYSTEM ---
    function renderStatus() {
        const container = document.getElementById('list-container');
        container.innerHTML = "<div style='padding:10px; color:var(--wa-light); font-weight:bold;'>Status Terbaru</div>";
        
        db.ref('statuses').on('value', snap => {
            if(currentTab !== 'status') return;
            container.innerHTML = "<div style='padding:10px; color:var(--wa-light); font-weight:bold;'>Status Terbaru</div>";
            
            snap.forEach(c => {
                const s = c.val();
                if(Date.now() - s.timestamp > 86400000) { c.ref.remove(); return; }

                const name = contacts[s.author] ? contacts[s.author].name : s.author;
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <svg class="border-svg"><rect class="border-path" x="0" y="0" width="100%" height="100%" rx="8"/></svg>
                    <div class="status-item" onclick="viewStatus('${s.author}', '${s.text}', '${c.key}')">
                        <div class="avatar" style="border:2px solid var(--wa-light)">${name[0].toUpperCase()}</div>
                        <div style="flex:1">
                            <div style="font-weight:bold">${name}</div>
                            <small>${new Date(s.timestamp).toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    function viewStatus(authorId, text, key) {
        document.getElementById('status-view').style.display = 'flex';
        document.getElementById('sw-author').innerText = contacts[authorId] ? contacts[authorId].name : authorId;
        document.getElementById('sw-text').innerText = text;
        db.ref('statuses/' + key + '/viewers/' + myId).set(true);
        notifyStatusView(authorId);
    }

    function handleFab() {
        if(currentTab === 'chats') {
            let id = prompt("Masukkan ID Teman:").trim().toLowerCase();
            if(id) { 
                let n = prompt("Nama Panggilan (Opsional):");
                contacts[id] = {id: id, name: n || id};
                saveCon();
            }
        } else {
            let t = prompt("Apa yang kamu pikirkan?");
            if(t) {
                db.ref('statuses').push({ author: myId, text: t, timestamp: Date.now() });
                // Notif ke semua kontak (simulasi)
                Object.keys(contacts).forEach(cid => { db.ref('inbox_status/' + cid).set(Date.now()); });
            }
        }
    }

    // --- UI UTILS ---
    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        t === 'chats' ? renderChats() : renderStatus();
        document.getElementById('main-fab').innerText = t === 'chats' ? '+' : '‚úé';
    }

    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; activeChat = null; }

    function notify(type, senderId) {
        const name = contacts[senderId] ? contacts[senderId].name : senderId;
        const t = document.getElementById('toast');
        t.innerText = `${type} Baru: ${name}`;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
        if (Notification.permission === "granted") new Notification("MyWA Ninja", { body: `${type} dari ${name}` });
    }

    renderChats();
    if (Notification.permission !== "granted") Notification.requestPermission();
</script>
</body>
</html>
