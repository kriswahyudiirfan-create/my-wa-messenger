<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyWA Pro V12.1 Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root { --green: #075e54; --teal: #128c7e; --light-green: #dcf8c6; --blue: #34b7f1; }
        
        /* Layout Dasar */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: #e5ddd5; 
            height: 100vh; 
            height: -webkit-fill-available; /* Fix untuk browser mobile */
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        header { background: var(--green); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; flex-shrink: 0; }
        
        /* Contact List */
        #contact-list { flex: 1; overflow-y: auto; background: white; -webkit-overflow-scrolling: touch; }
        .contact-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f2f2f2; position: relative; }
        .avatar { width: 45px; height: 45px; background: #ccc; border-radius: 50%; margin-right: 15px; position: relative; display: flex; align-items: center; justify-content: center; color: white; }
        .online-dot { width: 10px; height: 10px; background: #4caf50; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 0; right: 0; display: none; }
        .badge { background: #25d366; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; position: absolute; right: 15px; bottom: 15px; }

        /* Chat Screen - FIX POSISI */
        #chat-screen { 
            display: none; 
            flex-direction: column; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: #e5ddd5; 
            z-index: 1000; 
        }

        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            -webkit-overflow-scrolling: touch; 
        }

        /* Bubble Chat */
        .bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { background: var(--light-green); align-self: flex-end; border-top-right-radius: 0; }
        .received { background: white; align-self: flex-start; border-top-left-radius: 0; }
        
        .status-meta { display: flex; justify-content: flex-end; align-items: center; gap: 3px; font-size: 10px; opacity: 0.6; margin-top: 4px; }
        .tick-blue { color: var(--blue); }

        /* Footer Input - FIX TENGGELAM */
        footer { 
            background: #f0f0f0; 
            padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); /* Tambahan space untuk iPhone/Android baru */
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0; 
        }

        #input-msg { 
            flex: 1; 
            padding: 10px 15px; 
            border-radius: 20px; 
            border: 1px solid #ddd; 
            outline: none; 
            font-size: 15px; 
            max-height: 100px;
        }

        /* Call UI */
        #call-ui { display: none; position: fixed; inset: 0; background: var(--green); color: white; z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }

        .media-box img { max-width: 100%; border-radius: 5px; }
        .btn-dl { display: block; background: #eee; text-align: center; padding: 5px; margin-top: 5px; text-decoration: none; font-size: 12px; color: #333; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <div><strong>MyWA Pro</strong></div>
    <div id="my-id" style="font-size: 11px;">Connecting...</div>
</header>

<div id="contact-list">
    <div id="contacts-container"></div>
    <button onclick="addFriend()" style="width:100%; padding:15px; border:none; background:#eee; color:var(--teal); font-weight:bold;">+ TAMBAH KONTAK BARU</button>
</div>

<div id="chat-screen">
    <header style="padding: 8px 15px;">
        <div style="display:flex; align-items:center;">
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:22px; margin-right:10px;">‚Üê</button>
            <div>
                <span id="chat-title" style="font-size:16px; font-weight:bold;">Nama</span><br>
                <small id="chat-status" style="font-size:11px; opacity:0.8;">offline</small>
            </div>
        </div>
        <button onclick="alert('Fitur telfon sedang dioptimalkan!')" style="background:none; border:none; color:white; font-size:20px;">üìû</button>
    </header>
    <div id="messages"></div>
    <footer>
        <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:24px;">üìé</button>
        <input type="file" id="file-input" style="display:none" onchange="handleFile(this)">
        <input type="text" id="input-msg" placeholder="Ketik pesan..." oninput="notifyTyping()">
        <button onclick="sendText()" style="background:var(--teal); color:white; border:none; width:40px; height:40px; border-radius:50%; font-size:18px;">‚û§</button>
    </footer>
</div>

<script>
    let myId = localStorage.getItem('mywa_id_v12') || "";
    const peer = new Peer(myId);
    let currentId = "", conn;
    let contacts = JSON.parse(localStorage.getItem('mywa_contacts')) || [];
    let chats = JSON.parse(localStorage.getItem('mywa_chats')) || {};

    peer.on('open', id => {
        myId = id;
        localStorage.setItem('mywa_id_v12', id);
        document.getElementById('my-id').innerText = "ID: " + id;
    });

    peer.on('connection', c => {
        setupConn(c);
    });

    function setupConn(c) {
        conn = c;
        conn.on('data', data => handleData(data, c.peer));
    }

    function handleData(data, senderId) {
        if(data.type === 'typing') {
            if(currentId === senderId) {
                document.getElementById('chat-status').innerText = "sedang mengetik...";
                setTimeout(() => { document.getElementById('chat-status').innerText = "online"; }, 2000);
            }
        } else {
            saveMsg(senderId, data, 'received');
            if(currentId === senderId) {
                showMsg(data, 'received');
                conn.send({type: 'read_receipt', id: data.id});
            }
            renderContacts();
            new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3').play();
        }
    }

    function sendText() {
        const input = document.getElementById('input-msg');
        if(!input.value) return;
        const msg = { type: 'text', content: input.value, id: Date.now(), time: getTime() };
        if(conn) conn.send(msg);
        showMsg(msg, 'sent');
        saveMsg(currentId, msg, 'sent');
        input.value = "";
        
        // Bot Auto-Reply
        if(currentId === 'BOT') {
            setTimeout(() => {
                const reply = { type: 'text', content: "Pesan diterima Bot! ‚úÖ", id: Date.now(), time: getTime() };
                showMsg(reply, 'received');
                saveMsg('BOT', reply, 'received');
            }, 800);
        }
    }

    function showMsg(msg, side) {
        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `bubble ${side}`;
        
        let content = msg.content;
        if(msg.type === 'file') {
            if(msg.fileType.includes('image')) content = `<div class="media-box"><img src="${msg.content}"></div>`;
            else content = `üìÑ ${msg.fileName}`;
            content += `<a href="${msg.content}" download="${msg.fileName}" class="btn-dl">DOWNLOAD</a>`;
        }

        div.innerHTML = `${content} <div class="status-meta">${msg.time} ${side==='sent' ? '‚úîÔ∏è' : ''}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function handleFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const msg = { type: 'file', content: e.target.result, fileName: file.name, fileType: file.type, id: Date.now(), time: getTime() };
            if(conn) conn.send(msg);
            showMsg(msg, 'sent');
            saveMsg(currentId, msg, 'sent');
        };
        reader.readAsDataURL(file);
    }

    function addFriend() {
        let n = prompt("Nama Teman:"), i = prompt("ID PeerJS Teman:");
        if(n && i) {
            contacts.push({id: i, name: n});
            localStorage.setItem('mywa_contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    function renderContacts() {
        const container = document.getElementById('contacts-container');
        container.innerHTML = `<div class="contact-item" onclick="openChat('BOT', 'Bot Penguji')"><div class="avatar">ü§ñ</div><div><strong>Bot Penguji</strong><br><small>Tes sistem di sini</small></div></div>`;
        contacts.forEach(c => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `<div class="avatar">üë§<div class="online-dot" id="dot-${c.id}"></div></div><div><strong>${c.name}</strong><br><small>${c.id}</small></div>`;
            div.onclick = () => openChat(c.id, c.name);
            container.appendChild(div);
        });
    }

    function openChat(id, name) {
        currentId = id;
        document.getElementById('chat-title').innerText = name;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('messages').innerHTML = "";
        (chats[id] || []).forEach(m => showMsg(m.msg, m.side));
        if(id !== 'BOT') {
            conn = peer.connect(id);
            setupConn(conn);
        }
    }

    function saveMsg(id, msg, side) {
        if(!chats[id]) chats[id] = [];
        chats[id].push({msg, side});
        localStorage.setItem('mywa_chats', JSON.stringify(chats));
    }

    function getTime() { return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
    function notifyTyping() { if(conn) conn.send({type: 'typing'}); }
    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; currentId = ""; }

    renderContacts();
</script>
</body>
</html>
